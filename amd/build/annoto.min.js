function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);if(b)d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable});c.push.apply(c,d)}return c}function _objectSpread(a){for(var b=1,c;b<arguments.length;b++){c=null!=arguments[b]?arguments[b]:{};if(b%2){ownKeys(Object(c),!0).forEach(function(b){_defineProperty(a,b,c[b])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(a,Object.getOwnPropertyDescriptors(c))}else{ownKeys(Object(c)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(c,b))})}}return a}function _defineProperty(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}define ("local_annoto/annoto",["jquery","core/log","core/notification","core/ajax"],function(a,b,c,d){window.moodleAnnoto=window.moodleAnnoto||{};try{if(window.sessionStorage.getItem("moodleAnnotoDebug")){b=console}}catch(a){}return{init:function init(e,f){b.info("AnnotoMoodle: plugin init");d.call([{methodname:"get_jsparams",args:{courseid:e,modid:f},done:function(c){if(!c){b.error("AnnotoMoodle: empty params. Plugin won`t start.");return}this.params=JSON.parse(c);if(this.hasAnnotoTag()){b.info("AnnotoMoodle: plugin is disabled for this page using the Atto plugin.");return}this.tilesInit();this.setupKaltura();this.setupWistiaIframeEmbed();this.checkVimeoTime();a(document).ready(this.bootstrap.bind(this))}.bind(this),fail:c.exception}])},setupKaltura:function setupKaltura(){var a=window.moodleAnnoto.kApp;window.moodleAnnoto.setupKalturaKdpMap=this.setupKalturaKdpMap.bind(this);if(a){b.info("AnnotoMoodle: Kaltura loaded on init");this.setupKalturaKdpMap(a.kdpMap)}else{b.info("AnnotoMoodle: Kaltura not loaded on init")}},hasAnnotoTag:function hasAnnotoTag(){return 0<a("annoto").length&&0===a("annotodisable").length},findPlayer:function findPlayer(c){b.info("AnnotoMoodle: detecting player");var d=c||document.body,e=a(d).find("iframe.h5p-iframe").first().get(0),f=a(d).find("iframe[src*=\"youtube.com\"]").first().get(0),g=a(d).find("iframe[src*=\"vimeo.com\"]").first().get(0),h=a(d).find(".video-js").first().get(0),i=a(d).find(".jwplayer").first().get(0),j=a(d).find(".wistia_embed").first().get(0),k=a(d).find("video").first().get(0),l=null;if(h){l=h;this.params.playerType="videojs"}else if(i){l=i;this.params.playerType="jw"}else if(e){l=e;this.params.playerType="h5p"}else if(f){var m=f.src;if(-1===m.search(/enablejsapi/i)){f.src=-1===m.search(/[?]/)?m+"?enablejsapi=1":m+"&enablejsapi=1"}l=f;this.params.playerType="youtube"}else if(g){l=g;this.params.playerType="vimeo"}else if(j){l=j;this.params.playerType="wistia"}else if(k){l=k;this.params.playerType="html5"}else{b.info("AnnotoMoodle: no player was founded");return}if(!l.id||""===l.id){l.id="annoto_player_id_"+Math.random().toString(36).substr(2,6)}this.params.playerId="#".concat(l.id);this.params.element=l;return l},bootstrap:function bootstrap(){if(this.bootsrapDone){return}var a=this.findPlayer.call(this);if(a){this.bootsrapDone=!0;require([this.params.bootstrapUrl],this.bootWidget.bind(this));b.info("AnnotoMoodle: detected ".concat(this.params.playerType," : ").concat(this.params.playerId))}},prepareConfig:function prepareConfig(){var a=this.config,b=this.params;a.widgets[0].player.type=b.playerType;a.widgets[0].player.element=b.playerId;a.widgets[0].timeline={overlay:-1===["youtube","vimeo"].indexOf(b.playerType)}},bootWidget:function bootWidget(){var a=this.params,c=_objectSpread({backend:{domain:a.deploymentDomain},clientId:a.clientId,widgets:[{player:{}}],hooks:{mediaDetails:function mediaDetails(){return{details:{title:a.mediaTitle,description:a.mediaDescription}}},ssoAuthRequestHandle:function ssoAuthRequestHandle(){window.location.replace(a.loginUrl)}},group:{id:a.mediaGroupId,title:a.mediaGroupTitle,description:a.mediaGroupDescription}},a.locale&&{locale:a.locale});this.config=c;this.prepareConfig.call(this);if(window.Annoto){window.Annoto.on("ready",this.annotoReady.bind(this));if("videojs"===this.params.playerType&&window.requirejs){var d=this;window.require(["media_videojs/video-lazy"],function(a){d.config.widgets[0].player.params={videojs:a};window.Annoto.boot(d.config)})}else{window.Annoto.boot(this.config)}}else{b.warn("AnnotoMoodle: bootstrap didn`t load")}},annotoReady:function annotoReady(a){this.annotoAPI=a;var c=this.params.userToken;b.info("AnnotoMoodle: annoto ready");if(a&&c&&""!==c){a.auth(c).catch(function(){b.error("AnnotoMoodle: SSO auth error")});this.checkWidgetVisibility()}else{b.info("AnnotoMoodle: SSO auth skipped")}},authKalturaPlayer:function authKalturaPlayer(a){var c=this.params.userToken;b.info("AnnotoMoodle: annoto ready");if(a&&c&&""!==c){a.auth(c).catch(function(){b.error("AnnotoMoodle: SSO auth error")})}else{b.info("AnnotoMoodle: SSO auth skipped")}},setupKalturaKdpMap:function setupKalturaKdpMap(a){if(!a){b.info("AnnotoMoodle: skip setup Kaltura players - missing map");return}b.info("AnnotoMoodle: setup Kaltura players");for(var c in a){if(a.hasOwnProperty(c)){this.setupKalturaKdp(a[c])}}},setupKalturaKdp:function setupKalturaKdp(a){if(!a.config||a.setupDone||!a.doneCb){b.info("AnnotoMoodle: skip Kaltura player: "+a.id);return}b.info("AnnotoMoodle: setup Kaltura player: "+a.id);a.setupDone=!0;a.player.kBind("annotoPluginReady",this.authKalturaPlayer.bind(this));this.setupKalturaPlugin(a.config);a.doneCb()},setupKalturaPlugin:function setupKalturaPlugin(a){var b=this.params;a.clientId=b.clientId;a.hooks={getPageUrl:function getPageUrl(){return window.location.href},ssoAuthRequestHandle:function ssoAuthRequestHandle(){window.location.replace(b.loginUrl)},mediaDetails:this.enrichMediaDetails.bind(this)};a.group={id:b.mediaGroupId,title:b.mediaGroupTitle,description:b.mediaGroupDescription};if(b.locale){a.locale=b.locale}},enrichMediaDetails:function enrichMediaDetails(a){var b=a&&a.details||{};b.title=b.title||this.params.mediaTitle;b.description=b.description||this.params.mediaDescription;return b},checkWidgetVisibility:function checkWidgetVisibility(){var a="",c=this.params.element,d=this;if("undefined"!=typeof M.tabtopics){a="tabs"}else if("undefined"!=typeof M.format_grid){a="grid"}else if("undefined"!=typeof M.format_topcoll){a="topcoll"}else if("undefined"!=typeof M.snapTheme){a="snap"}else if("page-mod-tab-view"===document.body.id){a="modtab"}var e=function(e){var f=null;if(e){switch(a){case"tabs":f=e.filter(function(a){return a.target.classList.contains("yui3-tab-panel-selected")})[0].target;break;case"grid":f=e.filter(function(a){return!a.target.classList.contains("hide_section")})[0].target;break;case"topcoll":f=e[0].target;break;case"snap":f=e.filter(function(a){return a.target.classList.contains("state-visible")})[0].target;break;case"modtab":f=e.filter(function(a){return a.target.classList.contains("TabbedPanelsContentVisible")})[0].target;break;}}c=d.findPlayer(f);if(c){d.params.element=c;d.prepareConfig()}d.annotoAPI.destroy().then(function(){if(c.offsetParent){d.annotoAPI.load(d.config,function(a){if(a){b.warn("AnnotoMoodle: Error while reloading Annoto configuration");return}b.info("AnnotoMoodle: Loaded new Configuration!")})}})},f=document.querySelectorAll(Object.values({grid:"body.format-grid .grid_section, body.format-grid #gridshadebox",topcoll:"body.format-topcoll .ctopics.topics .toggledsection ",tabs:"body.format-tabtopics .yui3-tab-panel",snap:"body.format-topics.theme-snap .topics .section.main",modtab:"#page-mod-tab-view .TabbedPanelsContentGroup .TabbedPanelsContent"}).join(", "));if(0<f.length){var g={attributes:!0,childList:!0,subtree:!1},h=new MutationObserver(e);f.forEach(function(a){h.observe(a,g)});if(null===c.offsetParent){e()}}},setupWistiaIframeEmbed:function setupWistiaIframeEmbed(){var a=this,b=document.querySelectorAll("iframe");b.forEach(function(b){var c=decodeURIComponent(b.src);if(c.match(/https:\/\/fast.wistia.net\/embed\/iframe.*https:\/\/cdn.annoto.net/)){require(["https://cdn.annoto.net/widget-iframe-api/latest/client.js"],a.setupWistiaIframeEmbedPlugin.bind(a,b))}})},setupWistiaIframeEmbedPlugin:function setupWistiaIframeEmbedPlugin(a,c){var d=this.params,e=new c.Client(a);e.onSetup(function(a){a(_objectSpread({clientId:d.clientId,hooks:{mediaDetails:function mediaDetails(){return{details:{title:d.mediaTitle,description:d.mediaDescription}}},ssoAuthRequestHandle:function ssoAuthRequestHandle(){window.location.replace(d.loginUrl)},getPageUrl:function getPageUrl(){return window.location.href}},group:{id:d.mediaGroupId,title:d.mediaGroupTitle,description:d.mediaGroupDescription}},d.locale&&{locale:d.locale}))});e.onReady(function(a){var c=d.userToken;a.auth(c,function(a){if(a){b.error("AnnotoMoodle: SSO auth error",a)}})})},tilesInit:function tilesInit(){if(!document.body.classList.contains("format-tiles")){return}var a=this,c=function(c){var d=null;if(c){d=c.filter(function(a){return"class"===a.attributeName&&a.target.classList.contains("state-visible")})}if(!d.length){if(a.annotoAPI&&a.isloaded){a.annotoAPI.destroy().then(a.isloaded=!1)}return}setTimeout(function(){var c=a.findPlayer(d[0].target);if(c){a.params.playerId="#".concat(c.id);if(a.bootsrapDone){a.prepareConfig();a.annotoAPI.load(a.config,function(a){if(a){b.warn("AnnotoMoodle: Error while reloading Annoto configuration");return}b.info("AnnotoMoodle: Loaded new Configuration!")}).then(a.isloaded=!0)}else{a.bootsrapDone=a.isloaded=!0;require([a.params.bootstrapUrl],a.bootWidget.bind(a));b.info("AnnotoMoodle: detected "+a.params.playerType+":"+a.params.playerId)}}},2e3)},d=document.querySelectorAll(Object.values({tiles:"body.format-tiles #multi_section_tiles li.section.main.moveablesection"}).join(", "));if(0<d.length){var e={attributes:!0,childList:!1,subtree:!1},f=new MutationObserver(c);d.forEach(function(a){f.observe(a,e)})}},checkVimeoTime:function checkVimeoTime(){var a=document.getElementById("page-mod-videotime-view"),b=this,c=0,d=function(){var a=document.querySelector("iframe[src*=\"vimeo.com\"]");if(!a&&50>c){c++;setTimeout(d,100)}else{b.bootstrap()}};if(a){d()}}}});
//# sourceMappingURL=annoto.min.js.map
