/**
 * javscript for component 'local_annoto'.
 *
 * @package
 * @copyright  Annoto Ltd.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_annoto/annoto",["jquery","core/log","core/notification","core/ajax","local_annoto/completion","https://player.vimeo.com/api/player.js","https://vjs.zencdn.net/7.20.1/video.min.js"],(function($,log,notification,Ajax,Completion,VimeoPlayer,videoJsPlayer){window.moodleAnnoto=window.moodleAnnoto||{};try{window.sessionStorage.getItem("moodleAnnotoDebug")&&(log=console)}catch(err){}return{init:function(courseid,modid){$(document).find("body#page-mod-page-mod").get(0)||(log.info("AnnotoMoodle: plugin init"),Ajax.call([{methodname:"get_jsparams",args:{courseid:courseid,modid:modid},done:function(response){response.result?(this.params=JSON.parse(response.params),this.hasAnnotoTag()?log.info("AnnotoMoodle: plugin is disabled for this page using the Atto plugin."):(this.tilesInit(),this.icontent(),this.setupKaltura(),this.setupWistiaIframeEmbed(),this.checkVimeoTime(),$(document).ready(this.bootstrap.bind(this)))):log.warn("AnnotoMoodle: action not permitted for user")}.bind(this),fail:notification.exception}]))},setupKaltura:function(){const maKApp=window.moodleAnnoto.kApp;window.moodleAnnoto.setupKalturaKdpMap=this.setupKalturaKdpMap.bind(this),maKApp?(log.info("AnnotoMoodle: Kaltura loaded on init"),this.setupKalturaKdpMap(maKApp.kdpMap)):log.info("AnnotoMoodle: Kaltura not loaded on init")},hasAnnotoTag:function(){return $("annoto").length>0&&0===$("annotodisable").length},findPlayer:function(container){log.info("AnnotoMoodle: detecting player");const parent=container||document.body,h5p=$(parent).find("iframe.h5p-iframe").first().get(0),youtube=$(parent).find('iframe[src*="youtube.com"]').first().get(0),vimeo=$(parent).find('iframe[src*="vimeo.com"]').first().get(0),videojs=$(parent).find(".video-js").first().get(0),jwplayer=$(parent).find(".jwplayer").first().get(0),wistia=$(parent).find(".wistia_embed").first().get(0),html5=$(parent).find("video").first().get(0);let playerElement=null;if(videojs)playerElement=videojs,this.params.playerType="videojs";else if(jwplayer)playerElement=jwplayer,this.params.playerType="jw";else if(h5p)playerElement=h5p,this.params.playerType="h5p";else if(youtube){const youtubeSrc=youtube.src;-1===youtubeSrc.search(/enablejsapi/i)&&(youtube.src=-1===youtubeSrc.search(/[?]/)?youtubeSrc+"?enablejsapi=1":youtubeSrc+"&enablejsapi=1"),playerElement=youtube,this.params.playerType="youtube"}else if(vimeo)playerElement=vimeo,this.params.playerType="vimeo";else if(wistia)playerElement=wistia,this.params.playerType="wistia";else{if(!html5)return void log.info("AnnotoMoodle: no player was founded");playerElement=html5,this.params.playerType="html5"}return playerElement.id&&""!==playerElement.id||(playerElement.id="annoto_player_id_"+Math.random().toString(36).substr(2,6)),this.params.playerId="#".concat(playerElement.id),this.params.element=playerElement,playerElement},bootstrap:function(){if(this.bootsrapDone)return;this.findMultiplePlayers(),this.findPlayer.call(this)&&(this.bootsrapDone=!0,require([this.params.bootstrapUrl],this.bootWidget.bind(this)),log.info("AnnotoMoodle: detected ".concat(this.params.playerType," : ").concat(this.params.playerId)))},prepareConfig:function(){const config=this.config,params=this.params;config.widgets[0].player.type=params.playerType,config.widgets[0].player.element=params.playerId,config.widgets[0].timeline={overlay:-1===["youtube","vimeo"].indexOf(params.playerType)}},bootWidget:function(){const params=this.params,config={backend:{domain:params.deploymentDomain},demoMode:!1,clientId:params.clientId,widgets:[{player:{}}],hooks:{mediaDetails:function(){return{details:{title:params.mediaTitle,description:params.mediaDescription},outcomes:{isExpected:!0}}},ssoAuthRequestHandle:function(){window.location.replace(params.loginUrl)}},group:{id:params.mediaGroupId,title:params.mediaGroupTitle,description:params.mediaGroupDescription},...params.locale&&{locale:params.locale}};if(this.config=config,this.prepareConfig.call(this),window.Annoto)if(window.Annoto.on("ready",this.annotoReady.bind(this)),"videojs"===this.params.playerType&&window.requirejs){const self=this;window.require(["media_videojs/video-lazy"],(function(vjs){self.config.widgets[0].player.params={videojs:vjs},window.Annoto.boot(self.config)}))}else window.Annoto.boot(this.config);else log.warn("AnnotoMoodle: bootstrap didn`t load")},annotoReady:function(api){this.annotoAPI=api;const jwt=this.params.userToken;log.info("AnnotoMoodle: annoto ready"),api&&jwt&&""!==jwt?(api.auth(jwt).catch((function(){log.error("AnnotoMoodle: SSO auth error")})),this.checkWidgetVisibility()):log.info("AnnotoMoodle: SSO auth skipped"),window.Annoto.on("my_activity",(IMyActivity=>{IMyActivity.cmid=this.params.cmId,Completion.record(IMyActivity)}))},authKalturaPlayer:function(api){const jwt=this.params.userToken;log.info("AnnotoMoodle: annoto ready"),api&&jwt&&""!==jwt?api.auth(jwt).catch((function(){log.error("AnnotoMoodle: SSO auth error")})):log.info("AnnotoMoodle: SSO auth skipped")},setupKalturaKdpMap:function(kdpMap){if(kdpMap){log.info("AnnotoMoodle: setup Kaltura players");for(let kdpMapKey in kdpMap)kdpMap.hasOwnProperty(kdpMapKey)&&this.setupKalturaKdp(kdpMap[kdpMapKey])}else log.info("AnnotoMoodle: skip setup Kaltura players - missing map")},setupKalturaKdp:function(kdp){kdp.config&&!kdp.setupDone&&kdp.doneCb?(log.info("AnnotoMoodle: setup Kaltura player: "+kdp.id),kdp.setupDone=!0,kdp.player.kBind("annotoPluginReady",this.authKalturaPlayer.bind(this)),this.setupKalturaPlugin(kdp.config),kdp.doneCb()):log.info("AnnotoMoodle: skip Kaltura player: "+kdp.id)},setupKalturaPlugin:function(config){const params=this.params;config.clientId=params.clientId,config.hooks={getPageUrl:function(){return window.location.href},ssoAuthRequestHandle:function(){window.location.replace(params.loginUrl)},mediaDetails:this.enrichMediaDetails.bind(this)},config.group={id:params.mediaGroupId,title:params.mediaGroupTitle,description:params.mediaGroupDescription},params.locale&&(config.locale=params.locale)},enrichMediaDetails:function(mediaParams){const retVal=mediaParams&&mediaParams.details||{};return retVal.title=retVal.title||this.params.mediaTitle,retVal.description=retVal.description||this.params.mediaDescription,retVal},checkWidgetVisibility:function(){let courseFormat="",playerElement=this.params.element,self=this;void 0!==M.tabtopics?courseFormat="tabs":void 0!==M.format_grid?courseFormat="grid":void 0!==M.format_topcoll?courseFormat="topcoll":void 0!==M.snapTheme?courseFormat="snap":"page-mod-tab-view"===document.body.id&&(courseFormat="modtab");const reloadAnnoto=function(mutationList){let mutationTarget=null;if(mutationList)switch(courseFormat){case"tabs":mutationTarget=mutationList.filter((function(m){return m.target.classList.contains("yui3-tab-panel-selected")}))[0].target;break;case"grid":mutationTarget=mutationList.filter((function(m){return!m.target.classList.contains("hide_section")}))[0].target;break;case"topcoll":mutationTarget=mutationList[0].target;break;case"snap":mutationTarget=mutationList.filter((function(m){return m.target.classList.contains("state-visible")}))[0].target;break;case"modtab":mutationTarget=mutationList.filter((function(m){return m.target.classList.contains("TabbedPanelsContentVisible")}))[0].target}playerElement=self.findPlayer(mutationTarget),playerElement&&(self.params.element=playerElement,self.prepareConfig()),self.annotoAPI.destroy().then((function(){playerElement.offsetParent&&self.annotoAPI.load(self.config)}))},observerNodeTargets=document.querySelectorAll(Object.values({grid:"body.format-grid .grid_section, body.format-grid #gridshadebox",topcoll:"body.format-topcoll .ctopics.topics .toggledsection ",tabs:"body.format-tabtopics .yui3-tab-panel",snap:"body.format-topics.theme-snap .topics .section.main",modtab:"#page-mod-tab-view .TabbedPanelsContentGroup .TabbedPanelsContent"}).join(", "));if(observerNodeTargets.length>0){const observerConfig={attributes:!0,childList:!0,subtree:!1},observer=new MutationObserver(reloadAnnoto);observerNodeTargets.forEach((function(target){observer.observe(target,observerConfig)})),null===playerElement.offsetParent&&reloadAnnoto()}},setupWistiaIframeEmbed:function(){const wistiaplayers=document.querySelectorAll("iframe"),desiredParam_name="plugin[annoto][src]",desiredParam_value="cdn.annoto.net";wistiaplayers.forEach((iframe=>{let iframeSrc;try{iframeSrc=new URL(iframe.src)}catch(err){return}const targetParam=iframeSrc.searchParams.get(desiredParam_name);"fast.wistia.net"===iframeSrc.host&&targetParam&&targetParam.match(desiredParam_value)&&require(["https://cdn.annoto.net/widget-iframe-api/latest/client.js"],this.setupWistiaIframeEmbedPlugin.bind(this,iframe))}))},setupWistiaIframeEmbedPlugin:function(iframe,AnnotoIframeApi){const params=this.params,annoto=new AnnotoIframeApi.Client(iframe);annoto.onSetup((function(next){next({clientId:params.clientId,hooks:{mediaDetails:function(){return{details:{title:params.mediaTitle,description:params.mediaDescription},outcomes:{isExpected:!0}}},ssoAuthRequestHandle:function(){window.location.replace(params.loginUrl)},getPageUrl:function(){return window.location.href}},group:{id:params.mediaGroupId,title:params.mediaGroupTitle,description:params.mediaGroupDescription},...params.locale&&{locale:params.locale}})})),annoto.onReady((function(api){const token=params.userToken;api.auth(token,(function(err){err&&log.error("AnnotoMoodle: SSO auth error",err)}))}))},checkVimeoTime:function(){const isVimeoTime=document.getElementById("page-mod-videotime-view"),self=this;let setupRetry=0;const isReady=function(){!document.querySelector('iframe[src*="vimeo.com"]')&&setupRetry<50?(setupRetry++,setTimeout(isReady,100)):self.bootstrap()};isVimeoTime&&isReady()},tilesInit:function(){if(!document.body.classList.contains("format-tiles"))return;const self=this,reloadAnnoto=function(mutationList){let mutationTarget=null;mutationList&&(mutationTarget=mutationList.filter((function(m){return"class"===m.attributeName&&m.target.classList.contains("state-visible")}))),mutationTarget.length?setTimeout((function(){const player=self.findPlayer(mutationTarget[0].target);player&&(self.params.playerId="#".concat(player.id),self.bootsrapDone?(self.prepareConfig(),self.annotoAPI.load(self.config).then(self.isloaded=!0)):(self.bootsrapDone=self.isloaded=!0,require([self.params.bootstrapUrl],self.bootWidget.bind(self)),log.info("AnnotoMoodle: detected "+self.params.playerType+":"+self.params.playerId)))}),2e3):self.annotoAPI&&self.isloaded&&self.annotoAPI.destroy().then(self.isloaded=!1)},observerNodeTargets=document.querySelectorAll(Object.values({tiles:"body.format-tiles #multi_section_tiles li.section.main.moveablesection"}).join(", "));if(observerNodeTargets.length>0){const observerConfig={attributes:!0,childList:!1,subtree:!1},observer=new MutationObserver(reloadAnnoto);observerNodeTargets.forEach((function(target){observer.observe(target,observerConfig)}))}},icontent:function(){if(!document.body.classList.contains("path-mod-icontent"))return;const wrapper=document.getElementById("region-main"),idIcontentPages=document.getElementById("idicontentpages"),self=this;wrapper.addEventListener("click",(function(event){event.target.matches(".load-page")&&(self.annotoAPI&&self.isloaded&&self.annotoAPI.destroy().then(self.isloaded=!1),setTimeout((function(){const player=self.findPlayer(idIcontentPages);player&&(self.params.playerId="#".concat(player.id),self.bootsrapDone?(self.prepareConfig(),self.annotoAPI.load(self.config).then(self.isloaded=!0)):(self.bootsrapDone=self.isloaded=!0,require([self.params.bootstrapUrl],self.bootWidget.bind(self)),log.info("AnnotoMoodle: detected "+self.params.playerType+":"+self.params.playerId)))}),2e3))}))},findMultiplePlayers:function(){const self=this,vimeos=$("body").find('iframe[src*="vimeo.com"]').get(),videojs=$("body").find(".video-js").get(),allPlayers={...vimeos.length>1&&{vimeo:[...vimeos]},...videojs.length>1&&{videojs:[...videojs]}};let multiplePlayers=!1,activePlayerId=null;if(allPlayers.length)return multiplePlayers;multiplePlayers=!0,log.info("AnnotoMoodle: setup multiple players");const reloadAnnotoWidget=function(element,playerType){self.params.playerId="#".concat(element.id),self.params.element=element,self.params.playerType=playerType,self.prepareConfig(),self.annotoAPI.destroy().then((function(){self.annotoAPI.load(self.config),log.info("AnnotoMoodle: reload Player: ".concat(element.id))}))};for(const[playerType,players]of Object.entries(allPlayers))players.forEach((player=>{var element;switch((element=player).id&&""!==element.id||(element.id="annoto_player_id_"+Math.random().toString(36).substr(2,6)),element.id,log.info("AnnotoMoodle: setup Player: ".concat(player.id)),playerType){case"vimeo":new VimeoPlayer(player).on("play",(function(){player.id!==activePlayerId&&(activePlayerId=player.id,log.info("AnnotoMoodle: Player play: ".concat(player.id)),reloadAnnotoWidget(player,playerType))}));break;case"videojs":videoJsPlayer(player).player().on("play",(function(){player.id!==activePlayerId&&(activePlayerId=player.id,log.info("AnnotoMoodle: Player play: ".concat(player.id)),reloadAnnotoWidget(player,playerType))}))}}));return multiplePlayers}}}));

//# sourceMappingURL=annoto.min.js.map