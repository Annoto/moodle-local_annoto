define(["jquery","core/log","core/notification","core/ajax"],function(a,b,c,d){window.moodleAnnoto=window.moodleAnnoto||{};try{window.sessionStorage.getItem("moodleAnnotoDebug")&&(b=console)}catch(e){}return{init:function(e,f,g){b.info("AnnotoMoodle: plugin init"),d.call([{methodname:"get_jsparams",args:{courseid:e,pageurl:f,modid:g},done:function(c){var d=JSON.parse(c);return this.params=d,d?this.params.isGlobalScope||this.params.isACLmatch||this.hasAnnotoTag()?(this.setupKaltura(),void a(document).ready(this.bootstrap.bind(this))):void b.info("AnnotoMoodle: plugin is disabled for this page."):void b.error("AnnotoMoodle: empty params. Plugin won`t start.")}.bind(this),fail:c.exception}])},setupKaltura:function(){var a=window.moodleAnnoto.kApp;window.moodleAnnoto.setupKalturaKdpMap=this.setupKalturaKdpMap.bind(this),a?(b.info("AnnotoMoodle: Kaltura loaded on init"),this.setupKalturaKdpMap(a.kdpMap)):b.info("AnnotoMoodle: Kaltura not loaded on init")},hasAnnotoTag:function(){return a("annoto").length>0&&0===a("annotodisable").length},findPlayer:function(c){b.info("AnnotoMoodle: detecting player");var d=c||this.getCurrentPlayerParent()||document.body,e=a(d).find("iframe.h5p-iframe").first().get(0),f=a(d).find('iframe[src*="youtube.com"]').first().get(0),g=a(d).find('iframe[src*="vimeo.com"]').first().get(0),h=a(d).find(".video-js").first().get(0),i=a(d).find(".jwplayer").first().get(0),j=!1;if(h)j=h,this.params.playerType="videojs";else if(i)j=i,this.params.playerType="jw";else if(e)j=e,this.params.playerType="h5p";else if(f){var k=f.src;k.search(/enablejsapi/i)===-1&&(f.src=k.search(/[?]/)===-1?k+"?enablejsapi=1":k+"&enablejsapi=1"),j=f,this.params.playerType="youtube"}else g&&(j=g,this.params.playerType="vimeo");return j.id&&""!==j.id||(j.id=this.params.defaultPlayerId),j},bootstrap:function(){if(!this.bootsrapDone){var a=this.findPlayer.call(this);a&&(this.params.playerId=a.id,this.bootsrapDone=!0,require([this.params.bootstrapUrl],this.bootWidget.bind(this)),b.info("AnnotoMoodle: detected "+this.params.playerType+":"+this.params.playerId))}},prepareConfig:function(){var a=this.config,b=this.params,c=["youtube","vimeo"],d=["h5p"],e="element_edge";b.widgetOverlay&&"auto"!==b.widgetOverlay?"inner"===b.widgetOverlay&&(e="inner"):e=d.indexOf(b.playerType)!==-1?"inner":"element_edge",a.width={max:"inner"===e?320:360},a.align.horizontal=e,a.widgets[0].player.type=b.playerType,a.widgets[0].player.element=b.playerId,a.timeline={overlayVideo:c.indexOf(b.playerType)===-1}},bootWidget:function(){var a=this.params,c={clientId:a.clientId,position:a.position,features:{tabs:a.featureTab,cta:a.featureCTA},width:{},align:{vertical:a.alignVertical},ux:{ssoAuthRequestHandle:function(){window.location.replace(a.loginUrl)}},zIndex:a.zIndex?a.zIndex:100,widgets:[{player:{mediaDetails:function(){return{title:a.mediaTitle,description:a.mediaDescription,group:{id:a.mediaGroupId,type:"playlist",title:a.mediaGroupTitle,privateThread:a.privateThread}}}}}],demoMode:a.demoMode,rtl:a.rtl,locale:a.locale};if(this.config=c,this.prepareConfig.call(this),window.Annoto)if(window.Annoto.on("ready",this.annotoReady.bind(this)),"videojs"===this.params.playerType&&window.requirejs){var d=this;window.require(["media_videojs/video-lazy"],function(a){d.config.widgets[0].player.params={videojs:a},window.Annoto.boot(d.config)})}else window.Annoto.boot(this.config);else b.warn("AnnotoMoodle: bootstrap didn`t load")},annotoReady:function(a){this.annotoAPI=a;var c=this.params.userToken;b.info("AnnotoMoodle: annoto ready"),a&&c&&""!==c?(a.auth(c)["catch"](function(){b.error("AnnotoMoodle: SSO auth error")}),this.checkWidgetVisibility()):b.info("AnnotoMoodle: SSO auth skipped")},setupKalturaKdpMap:function(a){if(!a)return void b.info("AnnotoMoodle: skip setup Kaltura players - missing map");b.info("AnnotoMoodle: setup Kaltura players");for(var c in a)a.hasOwnProperty(c)&&this.setupKalturaKdp(a[c])},setupKalturaKdp:function(a){return a.config&&!a.setupDone&&a.doneCb?(b.info("AnnotoMoodle: setup Kaltura player: "+a.id),a.setupDone=!0,a.player.kBind("annotoPluginReady",this.annotoReady.bind(this)),this.setupKalturaPlugin(a.config),void a.doneCb()):void b.info("AnnotoMoodle: skip Kaltura player: "+a.id)},setupKalturaPlugin:function(a){var b=this.params,c=a.widgets[0],d=c.player,e=a.ux||{},f=a.align||{},g=a.features||{};a.ux=e,a.align=f,a.features=g,a.clientId=b.clientId,a.position=b.position,a.demoMode=b.demoMode,a.locale=b.locale,a.rtl=b.rtl,g.tabs=b.featureTab,g.cta=b.featureCTA,f.vertical=b.alignVertical,e.ssoAuthRequestHandle=function(){window.location.replace(b.loginUrl)},d.mediaDetails=this.enrichMediaDetails.bind(this)},enrichMediaDetails:function(a){var b=this.params,c=a||{};return c.title=c.title||b.mediaTitle,c.description=c.description?c.description:b.mediaDescription,c.group={id:b.mediaGroupId,type:"playlist",title:b.mediaGroupTitle,privateThread:b.privateThread},c},getCourseFormat:function(){var a="";return"undefined"!=typeof M.tabtopics?a="tabs":"undefined"!=typeof M.format_grid?a="grid":"undefined"!=typeof M.snapTheme&&(a="snap"),a},getCurrentPlayerParent:function(){var b,c=this.getCourseFormat(),d=!1;switch(c){case"tabs":b=a(this.playerParentSelectors.tabs).filter(".yui3-tab-panel-selected");break;case"grid":b=a(this.playerParentSelectors.grid).filter(":not(.hide_section)");break;case"snap":b=a(this.playerParentSelectors.snap).filter(".state-visible")}return"undefined"!=typeof b&&b.length>0&&(d=b.first()),d},playerParentSelectors:{grid:"body.format-grid .grid_section, body.format-grid #gridshadebox",tabs:"body.format-tabtopics .yui3-tab-panel",snap:"body.format-topics.theme-snap .topics .section.main"},checkWidgetVisibility:function(){var a=this.getCourseFormat(),c=document.getElementById(this.params.playerId),d=this,e=function(e){var f,g=[];if(e){switch(a){case"tabs":g=e.filter(function(a){return a.target.classList.contains("yui3-tab-panel-selected")});break;case"grid":g=e.filter(function(a){return!a.target.classList.contains("hide_section")});break;case"snap":g=e.filter(function(a){return a.target.classList.contains("state-visible")})}g.length>0&&(f=g[0].target)}var h=d.findPlayer(f);h&&(d.params.playerId=h.id,c=document.getElementById(d.params.playerId),d.prepareConfig()),d.annotoAPI.close(),null!==c.offsetParent&&d.annotoAPI.load(d.config,function(a){return a?void b.warn("AnnotoMoodle: Error while reloading Annoto configuration"):void b.info("AnnotoMoodle: Loaded new Configuration!")})},f=document.querySelectorAll(Object.values(this.playerParentSelectors).join(", "));if(f.length>0){var g={attributes:!0,childList:!0,subtree:!1},h=new MutationObserver(e);f.forEach(function(a){h.observe(a,g)}),null===c.offsetParent&&e()}}}});