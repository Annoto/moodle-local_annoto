/**
 * javscript for component 'local_annoto'.
 *
 * @package
 * @copyright  Annoto Ltd.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_annoto/annoto",["jquery","core/log","core/notification","core/ajax","https://player.vimeo.com/api/player.js","https://vjs.zencdn.net/7.20.1/video.min.js"],(function(t,e,o,n,i,a){window.moodleAnnoto=window.moodleAnnoto||{};try{window.sessionStorage.getItem("moodleAnnotoDebug")&&(e=console)}catch(t){}return{init:function(i,a){e.info("AnnotoMoodle: starting plugin init"),n.call([{methodname:"get_jsparams",args:{courseid:i,modid:a},done:function(o){o.result?(this.params=JSON.parse(o.params),this.tilesInit(),this.icontent(),this.setupKaltura(),this.setupWistiaIframeEmbed(),this.checkVimeoTime(),t(document).ready(this.bootstrap.bind(this))):e.warn("AnnotoMoodle: action not permitted for user")}.bind(this),fail:o.exception}])},setupKaltura:function(){const t=window.moodleAnnoto.kApp;window.moodleAnnoto.setupKalturaKdpMap=this.setupKalturaKdpMap.bind(this),t?(e.info("AnnotoMoodle: Kaltura loaded on init"),this.setupKalturaKdpMap(t.kdpMap)):e.info("AnnotoMoodle: Kaltura not loaded on init")},hasAnnotoTag:function(){return t("annoto").length>0&&0===t("annotodisable").length},findPlayer:function(o){e.info("AnnotoMoodle: detecting player");const n=o||document.body,i=t(n).find("iframe.h5p-iframe").first().get(0),a=t(n).find('iframe[src*="youtube.com"]').first().get(0),s=t(n).find('iframe[src*="vimeo.com"]').first().get(0),r=t(n).find(".video-js").first().get(0),l=t(n).find(".jwplayer").first().get(0),d=t(n).find(".wistia_embed").first().get(0),c=t(n).find("video").first().get(0);let p=null;if(r)p=r,this.params.playerType="videojs";else if(l)p=l,this.params.playerType="jw";else if(i)p=i,this.params.playerType="h5p";else if(a){const t=a.src;-1===t.search(/enablejsapi/i)&&(a.src=-1===t.search(/[?]/)?t+"?enablejsapi=1":t+"&enablejsapi=1"),p=a,this.params.playerType="youtube"}else if(s)p=s,this.params.playerType="vimeo";else if(d)p=d,this.params.playerType="wistia";else{if(!c)return void e.info("AnnotoMoodle: no player was founded");p=c,this.params.playerType="html5"}return p.id&&""!==p.id||(p.id="annoto_player_id_"+Math.random().toString(36).substr(2,6)),this.params.playerId=`#${p.id}`,this.params.element=p,p},bootstrap:function(){if(e.info("AnnotoMoodle: bootstrap"),this.bootsrapDone)return;if(this.findMultiplePlayers(),this.findPlayer.call(this)){const t=document.getElementById("page-wrapper");if(t){const o=document.createElement("div");o.id="annoto-app",t.appendChild(o),e.info("AnnotoMoodle:bootstrap updating annoto-app")}this.bootsrapDone=!0,require([this.params.bootstrapUrl],this.bootWidget.bind(this)),e.info(`AnnotoMoodle: bootstrap detected ${this.params.playerType} : ${this.params.playerId}`)}},prepareConfig:function(){const t=this.config,e=this.params;t.widgets[0].player.type=e.playerType,t.widgets[0].player.element=e.playerId,t.widgets[0].timeline={overlay:-1===["youtube","vimeo"].indexOf(e.playerType)}},bootWidget:function(){const t=this.params,o={backend:{domain:t.deploymentDomain},demoMode:!1,clientId:t.clientId,widgets:[{player:{}}],hooks:{mediaDetails:function(){return{details:{title:t.mediaTitle,description:t.mediaDescription},outcomes:{isExpected:!0}}},ssoAuthRequestHandle:function(){window.location.replace(t.loginUrl)}},group:{id:t.mediaGroupId,title:t.mediaGroupTitle,description:t.mediaGroupDescription},...t.locale&&{locale:t.locale}};if(this.config=o,this.prepareConfig.call(this),window.Annoto)if(window.Annoto.on("ready",this.annotoReady.bind(this)),"videojs"===this.params.playerType&&window.requirejs){const t=this;window.require(["media_videojs/video-lazy"],(function(e){t.config.widgets[0].player.params={videojs:e},window.Annoto.boot(t.config)}))}else window.Annoto.boot(this.config);else e.warn("AnnotoMoodle: bootstrap didn`t load")},annotoReady:function(t){this.annotoAPI=t;const o=this.params.userToken;e.info("AnnotoMoodle: annoto ready"),t&&o&&""!==o?(t.auth(o).catch((function(){e.error("AnnotoMoodle: SSO auth error")})),this.checkWidgetVisibility()):e.info("AnnotoMoodle: SSO auth skipped")},authKalturaPlayer:function(t){const o=this.params.userToken;e.info("AnnotoMoodle: annoto ready"),t&&o&&""!==o?t.auth(o).catch((function(){e.error("AnnotoMoodle: SSO auth error")})):e.info("AnnotoMoodle: SSO auth skipped")},setupKalturaKdpMap:function(t){if(t){e.info("AnnotoMoodle: setup Kaltura players");for(let e in t)t.hasOwnProperty(e)&&this.setupKalturaKdp(t[e])}else e.info("AnnotoMoodle: skip setup Kaltura players - missing map")},setupKalturaKdp:function(t){t.config&&!t.setupDone&&t.doneCb?(e.info("AnnotoMoodle: setup Kaltura player: "+t.id),t.setupDone=!0,t.player.kBind("annotoPluginReady",this.authKalturaPlayer.bind(this)),this.setupKalturaPlugin(t.config),t.doneCb()):e.info("AnnotoMoodle: skip Kaltura player: "+t.id)},setupKalturaPlugin:function(t){const e=this.params;t.clientId=e.clientId,t.hooks={getPageUrl:function(){return window.location.href},ssoAuthRequestHandle:function(){window.location.replace(e.loginUrl)},mediaDetails:this.enrichMediaDetails.bind(this)},t.group={id:e.mediaGroupId,title:e.mediaGroupTitle,description:e.mediaGroupDescription},e.locale&&(t.locale=e.locale)},enrichMediaDetails:function(t){const e=t&&t.details||{};return e.title=e.title||this.params.mediaTitle,e.description=e.description||this.params.mediaDescription,e},checkWidgetVisibility:function(){let t="",e=this.params.element,o=this;void 0!==M.tabtopics?t="tabs":void 0!==M.format_grid?t="grid":void 0!==M.format_topcoll?t="topcoll":void 0!==M.snapTheme?t="snap":"page-mod-tab-view"===document.body.id&&(t="modtab");const n=function(n){let i=null;if(n)switch(t){case"tabs":i=n.filter((function(t){return t.target.classList.contains("yui3-tab-panel-selected")}))[0].target;break;case"grid":i=n.filter((function(t){return!t.target.classList.contains("hide_section")}))[0].target;break;case"topcoll":i=n[0].target;break;case"snap":i=n.filter((function(t){return t.target.classList.contains("state-visible")}))[0].target;break;case"modtab":i=n.filter((function(t){return t.target.classList.contains("TabbedPanelsContentVisible")}))[0].target}e=o.findPlayer(i),e&&(o.params.element=e,o.prepareConfig()),o.annotoAPI.destroy().then((function(){e.offsetParent&&o.annotoAPI.load(o.config)}))},i=document.querySelectorAll(Object.values({grid:"body.format-grid .grid_section, body.format-grid #gridshadebox",topcoll:"body.format-topcoll .ctopics.topics .toggledsection ",tabs:"body.format-tabtopics .yui3-tab-panel",snap:"body.format-topics.theme-snap .topics .section.main",modtab:"#page-mod-tab-view .TabbedPanelsContentGroup .TabbedPanelsContent"}).join(", "));if(i.length>0){const t={attributes:!0,childList:!0,subtree:!1},o=new MutationObserver(n);i.forEach((function(e){o.observe(e,t)})),null===e.offsetParent&&n()}},setupWistiaIframeEmbed:function(){const t=document.querySelectorAll("iframe"),e="plugin[annoto][src]",o="cdn.annoto.net";t.forEach((t=>{let n;try{n=new URL(t.src)}catch(t){return}const i=n.searchParams.get(e);"fast.wistia.net"===n.host&&i&&i.match(o)&&require(["https://cdn.annoto.net/widget-iframe-api/latest/client.js"],this.setupWistiaIframeEmbedPlugin.bind(this,t))}))},setupWistiaIframeEmbedPlugin:function(t,o){const n=this.params,i=new o.Client(t);i.onSetup((function(t){t({clientId:n.clientId,hooks:{mediaDetails:function(){return{details:{title:n.mediaTitle,description:n.mediaDescription},outcomes:{isExpected:!0}}},ssoAuthRequestHandle:function(){window.location.replace(n.loginUrl)},getPageUrl:function(){return window.location.href}},group:{id:n.mediaGroupId,title:n.mediaGroupTitle,description:n.mediaGroupDescription},...n.locale&&{locale:n.locale}})})),i.onReady((function(t){const o=n.userToken;t.auth(o,(function(t){t&&e.error("AnnotoMoodle: SSO auth error",t)}))}))},checkVimeoTime:function(){const t=document.getElementById("page-mod-videotime-view"),e=this;let o=0;const n=function(){!document.querySelector('iframe[src*="vimeo.com"]')&&o<50?(o++,setTimeout(n,100)):e.bootstrap()};t&&n()},tilesInit:function(){if(!document.body.classList.contains("format-tiles"))return;const t=this,o=function(o){let n=null;o&&(n=o.filter((function(t){return"class"===t.attributeName&&t.target.classList.contains("state-visible")}))),n.length?setTimeout((function(){const o=t.findPlayer(n[0].target);o&&(t.params.playerId=`#${o.id}`,t.bootsrapDone?(t.prepareConfig(),t.annotoAPI.load(t.config).then(t.isloaded=!0)):(t.bootsrapDone=t.isloaded=!0,require([t.params.bootstrapUrl],t.bootWidget.bind(t)),e.info("AnnotoMoodle: detected "+t.params.playerType+":"+t.params.playerId)))}),2e3):t.annotoAPI&&t.isloaded&&t.annotoAPI.destroy().then(t.isloaded=!1)},n=document.querySelectorAll(Object.values({tiles:"body.format-tiles #multi_section_tiles li.section.main.moveablesection"}).join(", "));if(n.length>0){const t={attributes:!0,childList:!1,subtree:!1},e=new MutationObserver(o);n.forEach((function(o){e.observe(o,t)}))}},icontent:function(){if(!document.body.classList.contains("path-mod-icontent"))return;const t=document.getElementById("region-main"),o=document.getElementById("idicontentpages"),n=this;t.addEventListener("click",(function(t){t.target.matches(".load-page")&&(n.annotoAPI&&n.isloaded&&n.annotoAPI.destroy().then(n.isloaded=!1),setTimeout((function(){const t=n.findPlayer(o);t&&(n.params.playerId=`#${t.id}`,n.bootsrapDone?(n.prepareConfig(),n.annotoAPI.load(n.config).then(n.isloaded=!0)):(n.bootsrapDone=n.isloaded=!0,require([n.params.bootstrapUrl],n.bootWidget.bind(n)),e.info("AnnotoMoodle: detected "+n.params.playerType+":"+n.params.playerId)))}),2e3))}))},findMultiplePlayers:function(){e.info("AnnotoMoodle: find Multiple Players");const o=this,n=t("body").find('iframe[src*="vimeo.com"]').get(),s=t("body").find(".video-js").get(),r={...n.length>1&&{vimeo:[...n]},...s.length>1&&{videojs:[...s]}};let l=!1,d=null;if(r.length)return l;l=!0,e.info("AnnotoMoodle: setup multiple players");const c=function(t,n){o.params.playerId=`#${t.id}`,o.params.element=t,o.params.playerType=n,o.prepareConfig(),o.annotoAPI.destroy().then((function(){o.annotoAPI.load(o.config),e.info(`AnnotoMoodle: reload Player: ${t.id}`)}))};for(const[t,o]of Object.entries(r))o.forEach((o=>{var n;switch((n=o).id&&""!==n.id||(n.id="annoto_player_id_"+Math.random().toString(36).substr(2,6)),n.id,e.info(`AnnotoMoodle: setup Player: ${o.id}`),t){case"vimeo":new i(o).on("play",(function(){o.id!==d&&(d=o.id,e.info(`AnnotoMoodle: Player play: ${o.id}`),c(o,t))}));break;case"videojs":a(o).player().on("play",(function(){o.id!==d&&(d=o.id,e.info(`AnnotoMoodle: Player play: ${o.id}`),c(o,t))}))}}));return l}}}));