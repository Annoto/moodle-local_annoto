define ("local_annoto/annoto",["jquery","core/log","core/notification","core/ajax"],function(a,b,c,d){window.moodleAnnoto=window.moodleAnnoto||{};try{if(window.sessionStorage.getItem("moodleAnnotoDebug")){b=console}}catch(a){}return{init:function init(e,f,g){b.info("AnnotoMoodle: plugin init");d.call([{methodname:"get_jsparams",args:{courseid:e,pageurl:f,modid:g},done:function(c){var d=JSON.parse(c);this.params=d;if(!d){b.error("AnnotoMoodle: empty params. Plugin won`t start.");return}if(!this.params.isGlobalScope){if(!(this.params.isACLmatch||this.hasAnnotoTag())){b.info("AnnotoMoodle: plugin is disabled for this page.");return}}else if(this.hasAnnotoTag()){b.info("AnnotoMoodle: plugin is disabled for this page using the Atto plugin.");return}this.setupKaltura();this.setupWistiaIframeEmbed();a(document).ready(this.bootstrap.bind(this))}.bind(this),fail:c.exception}])},setupKaltura:function setupKaltura(){var a=window.moodleAnnoto.kApp;window.moodleAnnoto.setupKalturaKdpMap=this.setupKalturaKdpMap.bind(this);if(a){b.info("AnnotoMoodle: Kaltura loaded on init");this.setupKalturaKdpMap(a.kdpMap)}else{b.info("AnnotoMoodle: Kaltura not loaded on init")}},hasAnnotoTag:function hasAnnotoTag(){return 0<a("annoto").length&&0===a("annotodisable").length},findPlayer:function findPlayer(c){b.info("AnnotoMoodle: detecting player");var d=c||document.body,e=a(d).find("iframe.h5p-iframe").first().get(0),f=a(d).find("iframe[src*=\"youtube.com\"]").first().get(0),g=a(d).find("iframe[src*=\"vimeo.com\"]").first().get(0),h=a(d).find(".video-js").first().get(0),i=a(d).find(".jwplayer").first().get(0),j=a(d).find(".wistia_embed").first().get(0),k=a(d).find("video").first().get(0),l="";if(h){l=h;this.params.playerType="videojs"}else if(i){l=i;this.params.playerType="jw"}else if(e){l=e;this.params.playerType="h5p"}else if(f){var m=f.src;if(-1===m.search(/enablejsapi/i)){f.src=-1===m.search(/[?]/)?m+"?enablejsapi=1":m+"&enablejsapi=1"}l=f;this.params.playerType="youtube"}else if(g){l=g;this.params.playerType="vimeo"}else if(j){l=j;this.params.playerType="wistia"}else if(k){l=k;this.params.playerType="html5"}else{return}if(!l.id||""===l.id){l.id="annoto_player_id_"+Math.random().toString(36).substr(2,6)}return l},bootstrap:function bootstrap(){if(this.bootsrapDone){return}var a=this.findPlayer.call(this);if(a){this.params.playerId=a.id;this.bootsrapDone=!0;require([this.params.bootstrapUrl],this.bootWidget.bind(this));b.info("AnnotoMoodle: detected "+this.params.playerType+":"+this.params.playerId)}},prepareConfig:function prepareConfig(){var a=this.config,b=this.params,c="element_edge";if(!b.widgetOverlay||"auto"===b.widgetOverlay){c=-1!==["h5p"].indexOf(b.playerType)?"inner":"element_edge"}else if("inner"===b.widgetOverlay){c="inner"}a.width={max:"inner"==c?320:360};a.align.horizontal=c;a.widgets[0].player.type=b.playerType;a.widgets[0].player.element=b.playerId;a.timeline={overlayVideo:-1===["youtube","vimeo"].indexOf(b.playerType)}},bootWidget:function bootWidget(){var a=this.params,c={backend:{domain:a.deploymentDomain},clientId:a.clientId,position:a.position,features:{tabs:a.featureTab,cta:a.featureCTA},width:{},align:{vertical:a.alignVertical},ux:{ssoAuthRequestHandle:function ssoAuthRequestHandle(){window.location.replace(a.loginUrl)},openOnLoad:a.openOnLoad},zIndex:a.zIndex?a.zIndex:100,widgets:[{player:{mediaDetails:function mediaDetails(){return{title:a.mediaTitle,description:a.mediaDescription,group:{id:a.mediaGroupId,type:"playlist",title:a.mediaGroupTitle,privateThread:a.privateThread}}}}}],demoMode:a.demoMode,rtl:a.rtl,locale:a.locale};this.config=c;this.prepareConfig.call(this);if(window.Annoto){window.Annoto.on("ready",this.annotoReady.bind(this));if("videojs"===this.params.playerType&&window.requirejs){var d=this;window.require(["media_videojs/video-lazy"],function(a){d.config.widgets[0].player.params={videojs:a};window.Annoto.boot(d.config)})}else{window.Annoto.boot(this.config)}}else{b.warn("AnnotoMoodle: bootstrap didn`t load")}},annotoReady:function annotoReady(a){this.annotoAPI=a;var c=this.params.userToken;b.info("AnnotoMoodle: annoto ready");if(a&&c&&""!==c){a.auth(c).catch(function(){b.error("AnnotoMoodle: SSO auth error")});this.checkWidgetVisibility()}else{b.info("AnnotoMoodle: SSO auth skipped")}},authKalturaPlayer:function authKalturaPlayer(a){var c=this.params.userToken;b.info("AnnotoMoodle: annoto ready");if(a&&c&&""!==c){a.auth(c).catch(function(){b.error("AnnotoMoodle: SSO auth error")})}else{b.info("AnnotoMoodle: SSO auth skipped")}},setupKalturaKdpMap:function setupKalturaKdpMap(a){if(!a){b.info("AnnotoMoodle: skip setup Kaltura players - missing map");return}b.info("AnnotoMoodle: setup Kaltura players");for(var c in a){if(a.hasOwnProperty(c)){this.setupKalturaKdp(a[c])}}},setupKalturaKdp:function setupKalturaKdp(a){if(!a.config||a.setupDone||!a.doneCb){b.info("AnnotoMoodle: skip Kaltura player: "+a.id);return}b.info("AnnotoMoodle: setup Kaltura player: "+a.id);a.setupDone=!0;a.player.kBind("annotoPluginReady",this.authKalturaPlayer.bind(this));this.setupKalturaPlugin(a.config);a.doneCb()},setupKalturaPlugin:function setupKalturaPlugin(a){var b=this.params,c=a.widgets[0],d=c.player,e=a.ux||{},f=a.align||{},g=a.features||{};a.ux=e;a.align=f;a.features=g;a.clientId=b.clientId;a.position=b.position;a.demoMode=b.demoMode;a.locale=b.locale;a.rtl=b.rtl;g.tabs=b.featureTab;g.cta=b.featureCTA;f.vertical=b.alignVertical;e={ssoAuthRequestHandle:function ssoAuthRequestHandle(){window.location.replace(b.loginUrl)},openOnLoad:b.openOnLoad};d.mediaDetails=this.enrichMediaDetails.bind(this)},enrichMediaDetails:function enrichMediaDetails(a){var b=this.params,c=a||{};c.title=c.title||b.mediaTitle;c.description=c.description?c.description:b.mediaDescription;c.group={id:b.mediaGroupId,type:"playlist",title:b.mediaGroupTitle,privateThread:b.privateThread};return c},checkWidgetVisibility:function checkWidgetVisibility(){var a="";if("undefined"!=typeof M.tabtopics){a="tabs"}else if("undefined"!=typeof M.format_grid){a="grid"}else if("undefined"!=typeof M.format_topcoll){a="topcoll"}else if("undefined"!=typeof M.snapTheme){a="snap"}else if("page-mod-tab-view"===document.body.id){a="modtab"}if("modtab"===a){var i=document.querySelectorAll(".TabbedPanelsContent");i.forEach(function(a){a.id="modtab_"+Math.random().toString(36).substr(2,6)})}var c=document.getElementById(this.params.playerId),d=this,e=function(e){var f;if(e){switch(a){case"tabs":f=e.filter(function(a){return a.target.classList.contains("yui3-tab-panel-selected")})[0].target;break;case"grid":f=e.filter(function(a){return!a.target.classList.contains("hide_section")})[0].target;break;case"topcoll":f=e[0].target;break;case"snap":f=e.filter(function(a){return a.target.classList.contains("state-visible")})[0].target;break;case"modtab":f=e.filter(function(a){return a.target.classList.contains("TabbedPanelsContentVisible")})[0].target;break;}}var g=d.findPlayer(f);if(g){d.params.playerId=g.id;c=document.getElementById(d.params.playerId);d.prepareConfig()}d.annotoAPI.close().then(function(){if(c.offsetParent){d.annotoAPI.load(d.config,function(a){if(a){b.warn("AnnotoMoodle: Error while reloading Annoto configuration");return}b.info("AnnotoMoodle: Loaded new Configuration!")})}})},f=document.querySelectorAll(Object.values({grid:"body.format-grid .grid_section, body.format-grid #gridshadebox",topcoll:"body.format-topcoll .ctopics.topics .toggledsection ",tabs:"body.format-tabtopics .yui3-tab-panel",snap:"body.format-topics.theme-snap .topics .section.main",modtab:"#page-mod-tab-view .TabbedPanelsContentGroup .TabbedPanelsContent"}).join(", "));if(0<f.length){var g={attributes:!0,childList:!0,subtree:!1},h=new MutationObserver(e);f.forEach(function(a){h.observe(a,g)});if(null===c.offsetParent){e()}}},setupWistiaIframeEmbed:function setupWistiaIframeEmbed(){var a=this,b=document.querySelectorAll("iframe");b.forEach(function(b){var c=decodeURIComponent(b.src);if(c.match(/https:\/\/fast.wistia.net\/embed\/iframe.*https:\/\/cdn.annoto.net/)){require(["https://cdn.annoto.net/widget-iframe-api/latest/client.js"],a.setupWistiaIframeEmbedPlugin.bind(a,b))}})},setupWistiaIframeEmbedPlugin:function setupWistiaIframeEmbedPlugin(a,c){var d=this.params,e=new c.Client(a);e.onSetup(function(a){a({clientId:d.clientId,position:d.position,features:{tabs:d.featureTab,cta:d.featureCTA},align:{vertical:d.alignVertical},ux:{ssoAuthRequestHandle:function ssoAuthRequestHandle(){window.location.replace(d.loginUrl)},openOnLoad:d.openOnLoad,sidePanelLayout:d.sidePanelLayout,sidePanelFullScreen:d.sidePanelFullScreen},widgets:[{player:{mediaDetails:function mediaDetails(){return{title:d.mediaTitle,description:d.mediaDescription,group:{id:d.mediaGroupId,type:"playlist",title:d.mediaGroupTitle,privateThread:d.privateThread}}}}}],demoMode:d.demoMode,locale:d.locale})});e.onReady(function(a){a.registerOriginProvider({getPageUrl:function getPageUrl(){return location.href}});var c=d.userToken;a.auth(c,function(a){if(a){b.error("AnnotoMoodle: SSO auth error",a)}})})}}});
//# sourceMappingURL=annoto.min.js.map
