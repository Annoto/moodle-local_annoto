define ("local_annoto/annoto",["jquery","core/log","core/notification","core/ajax"],function(a,b,c,d){window.moodleAnnoto=window.moodleAnnoto||{};try{if(window.sessionStorage.getItem("moodleAnnotoDebug")){b=console}}catch(a){}return{init:function init(e,f,g){b.info("AnnotoMoodle: plugin init");d.call([{methodname:"get_jsparams",args:{courseid:e,pageurl:f,modid:g},done:function(c){var d=JSON.parse(c);this.params=d;if(!d){b.error("AnnotoMoodle: empty params. Plugin won`t start.");return}if(!this.params.isGlobalScope){if(!(this.params.isACLmatch||this.hasAnnotoTag())){b.info("AnnotoMoodle: plugin is disabled for this page.");return}}this.setupKaltura();a(document).ready(this.findPlayer.bind(this))}.bind(this),fail:c.exception}])},setupKaltura:function setupKaltura(){var a=window.moodleAnnoto.kApp;window.moodleAnnoto.setupKalturaKdpMap=this.setupKalturaKdpMap.bind(this);if(a){b.info("AnnotoMoodle: Kaltura loaded on init");this.setupKalturaKdpMap(a.kdpMap)}else{b.info("AnnotoMoodle: Kaltura not loaded on init")}},hasAnnotoTag:function hasAnnotoTag(){return 0<a("annoto").length&&0===a("annotodisable").length},findPlayer:function findPlayer(){b.info("AnnotoMoodle: detecting player");var c=a("iframe.h5p-iframe").first().get(0),d=a("iframe[src*=\"youtube.com\"]").first().get(0),e=a("iframe[src*=\"vimeo.com\"]").first().get(0),f=a(".video-js").first().get(0),g=a(".jwplayer").first().get(0),h="";if(f){h=f;this.params.playerType="videojs"}else if(g){h=g;this.params.playerType="jw"}else if(c){h=c;this.params.playerType="h5p"}else if(d){var i=d.src;if(-1===i.search(/enablejsapi/i)){d.src=-1===i.search(/[?]/)?i+"?enablejsapi=1":i+"&enablejsapi=1"}h=d;this.params.playerType="youtube"}else if(e){h=e;this.params.playerType="vimeo"}else{return}if(!h.id||""===h.id){h.id=this.params.defaultPlayerId}this.params.playerId=h.id;this.bootstrap();b.info("AnnotoMoodle: detected "+this.params.playerType+":"+this.params.playerId)},bootstrap:function bootstrap(){if(this.bootsrapDone){return}this.bootsrapDone=!0;require([this.params.bootstrapUrl],this.bootWidget.bind(this))},bootWidget:function bootWidget(){var a=this.params,c="element_edge";if(!a.widgetOverlay||"auto"===a.widgetOverlay){c=-1!==["h5p"].indexOf(a.playerType)?"inner":"element_edge"}else if("inner"===a.widgetOverlay){c="inner"}var d={clientId:a.clientId,position:a.position,features:{tabs:a.featureTab,cta:a.featureCTA},width:{max:"inner"===c?320:360},align:{vertical:a.alignVertical,horizontal:c},ux:{ssoAuthRequestHandle:function ssoAuthRequestHandle(){window.location.replace(a.loginUrl)}},zIndex:a.zIndex?a.zIndex:100,widgets:[{player:{type:a.playerType,element:a.playerId,mediaDetails:function mediaDetails(){return{title:a.mediaTitle,description:a.mediaDescription,group:{id:a.mediaGroupId,type:"playlist",title:a.mediaGroupTitle,privateThread:a.privateThread}}}},timeline:{overlayVideo:-1===["youtube","vimeo"].indexOf(a.playerType)}}],demoMode:a.demoMode,rtl:a.rtl,locale:a.locale};if(window.Annoto){window.Annoto.on("ready",this.annotoReady.bind(this));if("videojs"===a.playerType&&window.requirejs){window.require(["media_videojs/video-lazy"],function(a){d.widgets[0].player.params={videojs:a};window.Annoto.boot(d)})}else{window.Annoto.boot(d)}}else{b.warn("AnnotoMoodle: bootstrap didn`t load")}},annotoReady:function annotoReady(a){var c=this.params.userToken;b.info("AnnotoMoodle: annoto ready");if(a&&c&&""!==c){a.auth(c).catch(function(){b.error("AnnotoMoodle: SSO auth error")})}else{b.info("AnnotoMoodle: SSO auth skipped")}},setupKalturaKdpMap:function setupKalturaKdpMap(a){if(!a){b.info("AnnotoMoodle: skip setup Kaltura players - missing map");return}b.info("AnnotoMoodle: setup Kaltura players");for(var c in a){if(a.hasOwnProperty(c)){this.setupKalturaKdp(a[c])}}},setupKalturaKdp:function setupKalturaKdp(a){if(!a.config||a.setupDone||!a.doneCb){b.info("AnnotoMoodle: skip Kaltura player: "+a.id);return}b.info("AnnotoMoodle: setup Kaltura player: "+a.id);a.setupDone=!0;a.player.kBind("annotoPluginReady",this.annotoReady.bind(this));this.setupKalturaPlugin(a.config);a.doneCb()},setupKalturaPlugin:function setupKalturaPlugin(a){var b=this.params,c=a.widgets[0],d=c.player,e=a.ux||{},f=a.align||{},g=a.features||{};a.ux=e;a.align=f;a.features=g;a.clientId=b.clientId;a.position=b.position;a.demoMode=b.demoMode;a.locale=b.locale;a.rtl=b.rtl;g.tabs=b.featureTab;g.cta=b.featureCTA;f.vertical=b.alignVertical;e.ssoAuthRequestHandle=function(){window.location.replace(b.loginUrl)};d.mediaDetails=this.enrichMediaDetails.bind(this)},enrichMediaDetails:function enrichMediaDetails(a){var b=this.params,c=a||{};c.title=c.title||b.mediaTitle;c.description=c.description?c.description:b.mediaDescription;c.group={id:b.mediaGroupId,type:"playlist",title:b.mediaGroupTitle,privateThread:b.privateThread};return c}}});
//# sourceMappingURL=annoto.min.js.map
