define(["jquery","core/log","core/notification","core/ajax"],function(a,b,c,d){return{init:function(e,f,g){d.call([{methodname:"get_jsparams",args:{courseid:e,pageurl:f,modid:g},done:function(c){var d=JSON.parse(c);return this.params=d,d?this.params.isGlobalScope||this.params.isACLmatch||this.hasAnnotoTag()?void("undefined"!=typeof kWidget&&window.KApps?(b.info("Kaltura loaded"),window.KApps.annotoApp.kdp.kBind("annotoPluginReady",this.annotoReady.bind(this)),this.setupKalturaPlugin(window.KApps.annotoApp.config),window.KApps.annotoApp.doneCb()):(b.info("Kaltrura player not triggered"),a(document).ready(this.findPlayer.bind(this)))):void b.debug("Annoto is disabled for this page."):void b.warn("Empty params. Annoto will not start.")}.bind(this),fail:c.exception}])},hasAnnotoTag:function(){return a("annoto").length>0&&0===a("annotodisable").length},findPlayer:function(){var b=a("iframe.h5p-iframe").first().get(0),c=a('iframe[src*="youtube.com"]').first().get(0),d=a('iframe[src*="vimeo.com"]').first().get(0),e=a(".video-js").first().get(0),f="";if(e)f=e,this.params.playerType="videojs";else if(b)f=b,this.params.playerType="h5p";else if(c){var g=c.src;g.search(/enablejsapi/i)===-1&&(c.src=g.search(/[?]/)===-1?g+"?enablejsapi=1":g+"&enablejsapi=1"),f=c,this.params.playerType="youtube"}else{if(!d)return;f=d,this.params.playerType="vimeo"}f.id&&""!==f.id||(f.id=this.params.defaultPlayerId),this.params.playerId=f.id,this.bootstrap()},bootstrap:function(){this.bootsrapDone||(this.bootsrapDone=!0,require([this.params.bootstrapUrl],this.bootWidget.bind(this)))},bootWidget:function(){var a=this.params,c=["youtube","vimeo"],d=["h5p"],e="element_edge";a.widgetOverlay&&"auto"!==a.widgetOverlay?"inner"===a.widgetOverlay&&(e="inner"):e=d.indexOf(a.playerType)!==-1?"inner":"element_edge";var f={clientId:a.clientId,position:a.position,features:{tabs:a.featureTab,cta:a.featureCTA},width:{max:"inner"===e?320:360},align:{vertical:a.alignVertical,horizontal:e},ux:{ssoAuthRequestHandle:function(){window.location.replace(a.loginUrl)}},zIndex:a.zIndex?a.zIndex:100,widgets:[{player:{type:a.playerType,element:a.playerId,mediaDetails:function(){return{title:a.mediaTitle,description:a.mediaDescription,group:{id:a.mediaGroupId,type:"playlist",title:a.mediaGroupTitle,privateThread:a.privateThread}}}},timeline:{overlayVideo:c.indexOf(a.playerType)===-1}}],demoMode:a.demoMode,rtl:a.rtl,locale:a.locale};window.Annoto?(window.Annoto.on("ready",this.annotoReady.bind(this)),"videojs"===a.playerType&&window.requirejs?window.require(["media_videojs/video-lazy"],function(a){f.widgets[0].player.params={videojs:a},window.Annoto.boot(f)}):window.Annoto.boot(f)):b.warn("Annoto not loaded")},annotoReady:function(a){var c=a;c.auth(this.params.userToken)["catch"](function(){b.error("Annoto SSO auth error")})},setupKalturaPlugin:function(a){var b=this.params,c=a.widgets[0],d=c.player,e=a.ux||{},f=a.align||{},g=a.features||{};a.ux=e,a.align=f,a.features=g,a.clientId=b.clientId,a.position=b.position,a.demoMode=b.demoMode,a.locale=b.locale,a.rtl=b.rtl,g.tabs=b.featureTab,g.cta=b.featureCTA,f.vertical=b.alignVertical,e.ssoAuthRequestHandle=function(){window.location.replace(b.loginUrl)},d.mediaDetails=this.enrichMediaDetails.bind(this)},enrichMediaDetails:function(a){var b=this.params,c=a||{};return c.description=c.description?c.description:b.mediaDescription,c.group={id:b.mediaGroupId,type:"playlist",title:b.mediaGroupTitle,privateThread:b.privateThread},c}}});