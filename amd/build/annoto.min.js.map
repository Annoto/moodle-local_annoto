{"version":3,"sources":["../src/annoto.js"],"names":["define","$","log","notification","Ajax","window","moodleAnnoto","sessionStorage","getItem","console","err","init","courseid","pageurl","modid","info","call","methodname","args","done","response","params","JSON","parse","error","isGlobalScope","isACLmatch","hasAnnotoTag","setupKaltura","setupWistia","document","ready","bootstrap","bind","fail","exception","maKApp","kApp","setupKalturaKdpMap","kdpMap","length","findPlayer","container","parent","body","h5p","find","first","get","youtube","vimeo","videojs","jwplayer","wistia","annotoPlayer","playerType","youtubeSrc","src","search","id","defaultPlayerId","bootsrapDone","playerId","require","bootstrapUrl","bootWidget","prepareConfig","config","horizontalAlign","widgetOverlay","indexOf","width","max","align","horizontal","widgets","player","type","element","timeline","overlayVideo","clientId","position","features","tabs","featureTab","cta","featureCTA","vertical","alignVertical","ux","ssoAuthRequestHandle","location","replace","loginUrl","zIndex","mediaDetails","title","mediaTitle","description","mediaDescription","group","mediaGroupId","mediaGroupTitle","privateThread","demoMode","rtl","locale","Annoto","on","annotoReady","requirejs","self","vjs","boot","warn","api","annotoAPI","jwt","userToken","auth","catch","checkWidgetVisibility","kdpMapKey","hasOwnProperty","setupKalturaKdp","kdp","setupDone","doneCb","kBind","setupKalturaPlugin","widget","playerConfig","enrichMediaDetails","details","retVal","courseFormat","M","tabtopics","format_grid","snapTheme","playerNode","getElementById","reloadAnnoto","mutationList","mutationTarget","filter","m","target","classList","contains","close","then","offsetParent","load","observerNodeTargets","querySelectorAll","Object","values","grid","snap","join","observerConfig","attributes","childList","subtree","observer","MutationObserver","forEach","observe","wistiaplayer","iframe","iframeSrc","decodeURIComponent","bootWistiaPlayer","AnnotoIframeApi","annoto","Client","onSetup","next","onReady","registerOriginProvider","getPageUrl","href","token"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * javscript for component 'local_annoto'.\n *\n * @package    local_annoto\n * @copyright  Annoto Ltd.\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n  'jquery',\n  'core/log',\n  'core/notification',\n  'core/ajax',\n], function($, log, notification, Ajax) {\n\n    window.moodleAnnoto = window.moodleAnnoto || {};\n\n    try {\n        if (window.sessionStorage.getItem('moodleAnnotoDebug')) {\n            log = console;\n        }\n    } catch (err) {}\n\n    return {\n        init: function(courseid, pageurl, modid) {\n            log.info('AnnotoMoodle: plugin init');\n            Ajax.call([{\n                methodname: 'get_jsparams',\n                args: {\n                    courseid: courseid,\n                    pageurl: pageurl,\n                    modid: modid\n                },\n                done: function(response) {\n                    var params = JSON.parse(response);\n                    this.params = params;\n                    if (!params) {\n                        log.error('AnnotoMoodle: empty params. Plugin won`t start.');\n                        return;\n                    }\n\n                    // Return if plugin works in Global scope or is present in ACL or has <annoto> tag - continue this script.\n                    if (!this.params.isGlobalScope) {\n                        if (!(this.params.isACLmatch || this.hasAnnotoTag())) {\n                            log.info('AnnotoMoodle: plugin is disabled for this page.');\n                            return;\n                        }\n                    } else if (this.hasAnnotoTag()) {\n                        log.info('AnnotoMoodle: plugin is disabled for this page using the Atto plugin.');\n                        return;\n                    }\n\n                    this.setupKaltura();\n                    this.setupWistia();\n                    $(document).ready(this.bootstrap.bind(this));\n\n                }.bind(this),\n                fail: notification.exception\n            }]);\n\n        },\n        setupKaltura: function() {\n            var maKApp = window.moodleAnnoto.kApp;\n            window.moodleAnnoto.setupKalturaKdpMap = this.setupKalturaKdpMap.bind(this);\n\n            if (maKApp) {\n                log.info('AnnotoMoodle: Kaltura loaded on init');\n                this.setupKalturaKdpMap(maKApp.kdpMap);\n            } else {\n                log.info('AnnotoMoodle: Kaltura not loaded on init');\n            }\n        },\n        hasAnnotoTag: function() {\n            return ($('annoto').length > 0 && $('annotodisable').length === 0);\n        },\n        findPlayer: function(container) {\n            log.info('AnnotoMoodle: detecting player');\n            var parent = container || document.body,\n                h5p = $(parent).find('iframe.h5p-iframe').first().get(0),\n                youtube = $(parent).find('iframe[src*=\"youtube.com\"]').first().get(0),\n                vimeo = $(parent).find('iframe[src*=\"vimeo.com\"]').first().get(0),\n                videojs = $(parent).find('.video-js').first().get(0),\n                jwplayer = $(parent).find('.jwplayer').first().get(0),\n                wistia = $(parent).find('.wistia_embed').first().get(0),\n                annotoPlayer = '';\n\n            if (videojs) {\n                annotoPlayer = videojs;\n                this.params.playerType = 'videojs';\n            } else if (jwplayer) {\n                annotoPlayer = jwplayer;\n                this.params.playerType = 'jw';\n            } else if (h5p) {\n                annotoPlayer = h5p;\n                this.params.playerType = 'h5p';\n            } else if (youtube) {\n                var youtubeSrc = youtube.src;\n                if (youtubeSrc.search(/enablejsapi/i) === -1) {\n                    youtube.src = (youtubeSrc.search(/[?]/) === -1) ? youtubeSrc + '?enablejsapi=1' : youtubeSrc + '&enablejsapi=1';\n                }\n                annotoPlayer = youtube;\n                this.params.playerType = 'youtube';\n            } else if (vimeo) {\n                annotoPlayer = vimeo;\n                this.params.playerType = 'vimeo';\n            }else if (wistia) {\n                annotoPlayer = wistia;\n                this.params.playerType = 'wistia';\n            }else {\n                return;\n            }\n            if (!annotoPlayer.id || annotoPlayer.id === '') {\n                annotoPlayer.id = this.params.defaultPlayerId;\n            }\n\n            return annotoPlayer;\n        },\n        bootstrap: function() {\n            if (this.bootsrapDone) {\n                return;\n            }\n\n            var annotoPlayer = this.findPlayer.call(this);\n\n            if (annotoPlayer) {\n                this.params.playerId = annotoPlayer.id;\n                this.bootsrapDone = true;\n                require([this.params.bootstrapUrl], this.bootWidget.bind(this));\n                log.info('AnnotoMoodle: detected ' + this.params.playerType + ':' + this.params.playerId);\n            }\n        },\n        prepareConfig: function() {\n            var config = this.config,\n                params = this.params,\n                nonOverlayTimelinePlayers = ['youtube', 'vimeo'],\n                innerAlignPlayers = ['h5p'],\n                horizontalAlign = 'element_edge';\n\n            if (!params.widgetOverlay || params.widgetOverlay === 'auto') {\n                horizontalAlign = (innerAlignPlayers.indexOf(params.playerType) !== -1) ? 'inner' : 'element_edge';\n            } else if (params.widgetOverlay === 'inner') {\n                horizontalAlign = 'inner';\n            }\n\n            config.width = {max: (horizontalAlign === 'inner') ? 320 : 360};\n            config.align.horizontal = horizontalAlign;\n            config.widgets[0].player.type = params.playerType;\n            config.widgets[0].player.element = params.playerId;\n            config.timeline = {\n                overlayVideo: (nonOverlayTimelinePlayers.indexOf(params.playerType) === -1),\n            };\n        },\n        bootWidget: function() {\n            var params = this.params;\n            var config = {\n                clientId: params.clientId,\n                position: params.position,\n                features: {\n                    tabs: params.featureTab,\n                    cta: params.featureCTA,\n                },\n                width: {},\n                align: {\n                    vertical: params.alignVertical,\n                },\n                ux: {\n                    ssoAuthRequestHandle: function() {\n                        window.location.replace(params.loginUrl);\n                    },\n                },\n                zIndex: params.zIndex ? params.zIndex : 100,\n                widgets: [{\n                    player: {\n                        mediaDetails: function() {\n                            return {\n                                title: params.mediaTitle,\n                                description: params.mediaDescription,\n                                group: {\n                                    id: params.mediaGroupId,\n                                    type: 'playlist',\n                                    title: params.mediaGroupTitle,\n                                    privateThread: params.privateThread,\n                                }\n                            };\n                        },\n                    },\n                }],\n                demoMode: params.demoMode,\n                rtl: params.rtl,\n                locale: params.locale,\n            };\n\n            this.config = config;\n\n            this.prepareConfig.call(this);\n\n            if (window.Annoto) {\n                window.Annoto.on('ready', this.annotoReady.bind(this));\n                if (this.params.playerType === 'videojs' && window.requirejs) {\n                    var self = this;\n                    window.require(['media_videojs/video-lazy'], function(vjs) {\n                        self.config.widgets[0].player.params = {\n                            videojs: vjs\n                        };\n                        window.Annoto.boot(self.config);\n                    });\n                } else {\n                    window.Annoto.boot(this.config);\n                }\n\n            } else {\n                log.warn('AnnotoMoodle: bootstrap didn`t load');\n            }\n        },\n\n        annotoReady: function(api) {\n            // Api is the API to be used after Annoot is setup\n            // It can be used for SSO auth.\n            this.annotoAPI = api;\n            var jwt = this.params.userToken;\n            log.info('AnnotoMoodle: annoto ready');\n            if (api && jwt && jwt !== '') {\n                api.auth(jwt).catch(function() {\n                    log.error('AnnotoMoodle: SSO auth error');\n                });\n                this.checkWidgetVisibility();\n            } else {\n                log.info('AnnotoMoodle: SSO auth skipped');\n            }\n        },\n\n        setupKalturaKdpMap: function(kdpMap) {\n            if (!kdpMap) {\n                log.info('AnnotoMoodle: skip setup Kaltura players - missing map');\n                return;\n            }\n            log.info('AnnotoMoodle: setup Kaltura players');\n            for (var kdpMapKey in kdpMap) {\n                if (kdpMap.hasOwnProperty(kdpMapKey)) {\n                    this.setupKalturaKdp(kdpMap[kdpMapKey]);\n                }\n            }\n        },\n        setupKalturaKdp: function(kdp) {\n            if (!kdp.config || kdp.setupDone || !kdp.doneCb) {\n                log.info('AnnotoMoodle: skip Kaltura player: ' + kdp.id);\n                return;\n            }\n            log.info('AnnotoMoodle: setup Kaltura player: ' + kdp.id);\n            kdp.setupDone = true;\n            kdp.player.kBind('annotoPluginReady', this.annotoReady.bind(this));\n            this.setupKalturaPlugin(kdp.config);\n            kdp.doneCb();\n        },\n        setupKalturaPlugin: function(config) {\n            /*\n             * Config will contain the annoto widget configuration.\n             * This hook provides a chance to modify the configuration if required.\n             * Below we use this chance to attach the ssoAuthRequestHandle and mediaDetails hooks.\n             * https://github.com/Annoto/widget-api/blob/master/lib/config.d.ts#L128\n             *\n             * NOTICE: config is already setup by the Kaltura Annoto plugin,\n             * so we need only to override the required configuration, such as\n             * clientId, features, etc. DO NOT CHANGE THE PLAYER TYPE OR PLAYER ELEMENT CONFIG.\n            */\n            var params = this.params;\n            var widget = config.widgets[0];\n            var playerConfig = widget.player;\n            var ux = config.ux || {};\n            var align = config.align || {};\n            var features = config.features || {};\n\n            config.ux = ux;\n            config.align = align;\n            config.features = features;\n\n            config.clientId = params.clientId;\n            config.position = params.position;\n            config.demoMode = params.demoMode;\n            config.locale = params.locale;\n            config.rtl = params.rtl;\n\n            features.tabs = params.featureTab;\n            features.cta = params.featureCTA;\n            align.vertical = params.alignVertical;\n            ux.ssoAuthRequestHandle = function() {\n                window.location.replace(params.loginUrl);\n            };\n            playerConfig.mediaDetails = this.enrichMediaDetails.bind(this);\n        },\n\n        enrichMediaDetails: function(details) {\n            // The details contains MediaDetails the plugin has managed to obtain\n            // This hook gives a change to enrich the details, for example\n            // providing group information for private discussions per course/playlist\n            // https://github.com/Annoto/widget-api/blob/master/lib/media-details.d.ts#L6.\n            // Annoto Kaltura plugin, already has some details about the media like title.\n            //\n            var params = this.params;\n            var retVal = details || {};\n\n            retVal.title = retVal.title || params.mediaTitle;\n            retVal.description = retVal.description ? retVal.description : params.mediaDescription;\n            retVal.group = {\n                id: params.mediaGroupId,\n                type: 'playlist',\n                title: params.mediaGroupTitle,\n                privateThread: params.privateThread,\n            };\n\n            return retVal;\n        },\n\n        checkWidgetVisibility: function() {\n            var formatSelectors = {\n                grid: 'body.format-grid .grid_section, body.format-grid #gridshadebox',\n                tabs: 'body.format-tabtopics .yui3-tab-panel',\n                snap: 'body.format-topics.theme-snap .topics .section.main'\n            };\n            var courseFormat = '';\n\n            if (typeof M.tabtopics !== 'undefined') {\n                courseFormat = 'tabs';\n            } else if (typeof M.format_grid !== 'undefined') {\n                courseFormat = 'grid';\n            } else if (typeof M.snapTheme !== 'undefined') {\n                courseFormat = 'snap';\n            }\n\n            var playerNode = document.getElementById(this.params.playerId),\n                self = this;\n\n            var reloadAnnoto = function(mutationList) {\n                var mutationTarget;\n\n                if (mutationList) {\n                      switch (courseFormat) {\n                      case 'tabs':\n                        mutationTarget = mutationList.filter(function(m) {\n                          return m.target.classList.contains('yui3-tab-panel-selected');\n                        })[0].target;\n                        break;\n                      case 'grid':\n                        mutationTarget = mutationList.filter(function(m) {\n                          return !m.target.classList.contains('hide_section');\n                        })[0].target;\n                        break;\n                      case 'snap':\n                        mutationTarget = mutationList.filter(function(m) {\n                          return m.target.classList.contains('state-visible');\n                        })[0].target;\n                        break;\n                    }\n                }\n                var player = self.findPlayer(mutationTarget);\n\n                if (player) {\n                    self.params.playerId = player.id;\n                    playerNode = document.getElementById(self.params.playerId);\n                    self.prepareConfig();\n                }\n\n                self.annotoAPI.close().then(function(){\n                    if (playerNode.offsetParent !== null) {\n                        self.annotoAPI.load(self.config, function(err) {\n                            if (err) {\n                                log.warn('AnnotoMoodle: Error while reloading Annoto configuration');\n                                return;\n                            }\n                            log.info('AnnotoMoodle: Loaded new Configuration!');\n                        });\n                    }\n                });\n              };\n\n            var observerNodeTargets = document.querySelectorAll(Object.values(formatSelectors).join(', '));\n\n            if (observerNodeTargets.length > 0) {\n                var observerConfig = {attributes: true, childList: true, subtree: false},\n                    observer = new MutationObserver(reloadAnnoto);\n\n                observerNodeTargets.forEach(function(target) {\n                    observer.observe(target, observerConfig);\n                });\n\n                if (playerNode.offsetParent === null) {\n                    reloadAnnoto();\n                }\n            }\n\n        },\n\n        setupWistia: function(){\n            var annotoIframeClient = \"https://cdn.annoto.net/widget-iframe-api/latest/client.js\",\n                annotoIframeUrl = \"https://cdn.annoto.net\",\n                wistiaplayer = document.querySelectorAll('iframe');\n\n            wistiaplayer.forEach((iframe) => {\n                var iframeSrc = decodeURIComponent(iframe.src);\n                if (iframeSrc.indexOf(annotoIframeUrl) !== -1) {\n                    require([annotoIframeClient], this.bootWistiaPlayer.bind(this, iframe));\n                    return;\n                }\n            });\n        },\n\n        bootWistiaPlayer: function(iframe, AnnotoIframeApi){\n            var params = this.params,\n                annoto = new AnnotoIframeApi.Client(iframe);\n\n            annoto.onSetup(function (next) {\n                next({\n                    clientId: params.clientId,\n                    position: params.position,\n                    features: {\n                        tabs: params.featureTab,\n                        cta: params.featureCTA,\n                    },\n                    width: {},\n                    align: {\n                        vertical: params.alignVertical,\n                    },\n                    zIndex: params.zIndex ? params.zIndex : 100,\n                    widgets: [{\n                        player: {\n                            mediaDetails: function() {\n                                return {\n                                    title: params.mediaTitle,\n                                    description: params.mediaDescription,\n                                    group: {\n                                        id: params.mediaGroupId,\n                                        type: 'playlist',\n                                        title: params.mediaGroupTitle,\n                                        privateThread: params.privateThread,\n                                    }\n                                };\n                            },\n                        },\n                    }],\n                    demoMode: params.demoMode,\n                    rtl: params.rtl,\n                    locale: params.locale,\n                });\n            });\n\n            annoto.onReady(function (api) {\n                // recomended, so notifications will have URL to valid pages\n                api.registerOriginProvider({\n                    getPageUrl: function () {\n                        return location.href;\n                    },\n                });\n                var token = params.userToken;\n                api.auth(token, function (err) {\n                    if (err) {\n                        log.error('AnnotoWistia: SSO auth error', err);\n                    }else log.info('AnnotoWistia: SSO auth skipped');\n                });\n            });\n        }\n    };\n});\n"],"file":"annoto.min.js"}