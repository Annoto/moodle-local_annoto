{"version":3,"file":"annoto.min.js","sources":["../src/annoto.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * javscript for component 'local_annoto'.\n *\n * @package    local_annoto\n * @copyright  Annoto Ltd.\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/log',\n    'core/notification',\n    'core/ajax'\n  ], function($, log, notification, Ajax) {\n\n      window.moodleAnnoto = window.moodleAnnoto || {};\n\n      try {\n          if (window.sessionStorage.getItem('moodleAnnotoDebug')) {\n              log = console;\n          }\n      } catch (err) {}\n\n      return {\n          init: function(courseid, modid) {\n              log.info('AnnotoMoodle: plugin init');\n              Ajax.call([{\n                  methodname: 'get_jsparams',\n                  args: {\n                      courseid: courseid,\n                      modid: modid\n                  },\n                  done: function(response) {\n                      if (!response.result) {\n                          log.warn('AnnotoMoodle: action not permitted for user');\n                          return;\n                      }\n                      this.params = JSON.parse(response.params);\n\n                      // Return if has <annoto> tag.\n                      if (this.hasAnnotoTag()) {\n                          log.info('AnnotoMoodle: plugin is disabled for this page using the Atto plugin.');\n                          return;\n                      }\n\n                      this.tilesInit();\n                      this.setupKaltura();\n                      this.setupWistiaIframeEmbed();\n                      this.checkVimeoTime();\n                      this.moodleversion = JSON.parse(response.params).moodleversion;\n                      $(document).ready(this.bootstrap.bind(this));\n\n                  }.bind(this),\n                  fail: notification.exception\n              }]);\n\n          },\n          setupKaltura: function() {\n              const maKApp = window.moodleAnnoto.kApp;\n              window.moodleAnnoto.setupKalturaKdpMap = this.setupKalturaKdpMap.bind(this);\n\n              if (maKApp) {\n                  log.info('AnnotoMoodle: Kaltura loaded on init');\n                  this.setupKalturaKdpMap(maKApp.kdpMap);\n              } else {\n                  log.info('AnnotoMoodle: Kaltura not loaded on init');\n              }\n          },\n          hasAnnotoTag: function() {\n              return ($('annoto').length > 0 && $('annotodisable').length === 0);\n          },\n          findPlayer: function(container) {\n              log.info('AnnotoMoodle: detecting player');\n              const parent = container || document.body,\n                  h5p = $(parent).find('iframe.h5p-iframe').first().get(0),\n                  youtube = $(parent).find('iframe[src*=\"youtube.com\"]').first().get(0),\n                  vimeo = $(parent).find('iframe[src*=\"vimeo.com\"]').first().get(0),\n                  videojs = $(parent).find('.video-js').first().get(0),\n                  jwplayer = $(parent).find('.jwplayer').first().get(0),\n                  wistia = $(parent).find('.wistia_embed').first().get(0),\n                  html5 = $(parent).find('video').first().get(0);\n              let playerElement = null;\n\n              if (videojs) {\n                  playerElement = videojs;\n                  this.params.playerType = 'videojs';\n              } else if (jwplayer) {\n                  playerElement = jwplayer;\n                  this.params.playerType = 'jw';\n              } else if (h5p) {\n                  playerElement = h5p;\n                  this.params.playerType = 'h5p';\n              } else if (youtube) {\n                  const youtubeSrc = youtube.src;\n                  if (youtubeSrc.search(/enablejsapi/i) === -1) {\n                    youtube.src = (youtubeSrc.search(/[?]/) === -1) ? youtubeSrc + '?enablejsapi=1' : youtubeSrc + '&enablejsapi=1';\n                  }\n                  playerElement = youtube;\n                  this.params.playerType = 'youtube';\n              } else if (vimeo) {\n                  playerElement = vimeo;\n                  this.params.playerType = 'vimeo';\n              } else if (wistia) {\n                  playerElement = wistia;\n                  this.params.playerType = 'wistia';\n              } else if (html5) {\n                  playerElement = html5;\n                  this.params.playerType = 'html5';\n              } else {\n                  log.info('AnnotoMoodle: no player was founded');\n                  return;\n              }\n              if (!playerElement.id || playerElement.id === '') {\n                  playerElement.id = 'annoto_player_id_' + Math.random().toString(36).substr(2, 6);\n              }\n              this.params.playerId = `#${playerElement.id}`;\n              this.params.element = playerElement;\n\n              return playerElement;\n          },\n          bootstrap: function() {\n              if(this.moodleversion[0] === \"4\") {\n                  const innerPage = document.querySelector(\"#page\");\n                  const newDiv = document.createElement(\"div\");\n                  newDiv.id=\"annoto-app\";\n                  innerPage.appendChild(newDiv);\n              }\n\n              if (this.bootsrapDone) {\n                  return;\n              }\n\n              const annotoPlayer = this.findPlayer.call(this);\n              if (annotoPlayer) {\n                  this.bootsrapDone = true;\n                  require([this.params.bootstrapUrl], this.bootWidget.bind(this));\n                  log.info(`AnnotoMoodle: detected ${this.params.playerType} : ${this.params.playerId}`);\n              }\n          },\n          prepareConfig: function() {\n              const config = this.config,\n                  params = this.params,\n                  nonOverlayTimelinePlayers = ['youtube', 'vimeo'];\n\n              config.widgets[0].player.type = params.playerType;\n              config.widgets[0].player.element = params.playerId;\n              config.widgets[0].timeline = {\n                  overlay: (nonOverlayTimelinePlayers.indexOf(params.playerType) === -1),\n              };\n          },\n          bootWidget: function() {\n              const params = this.params;\n              const config = {\n                  backend: {\n                    domain: params.deploymentDomain\n                  },\n                  clientId: params.clientId,\n                  widgets: [{player: {}}],\n                  hooks: {\n                      mediaDetails: function() {\n                          return {\n                              details: {\n                                  title: params.mediaTitle,\n                                  description: params.mediaDescription,\n                              }\n                          };\n                      },\n                      ssoAuthRequestHandle: function() {\n                          window.location.replace(params.loginUrl);\n                      },\n                  },\n                  group: {\n                      id: params.mediaGroupId,\n                      title: params.mediaGroupTitle,\n                      description: params.mediaGroupDescription,\n                  },\n                  ... (params.locale) && {locale: params.locale},\n              };\n\n              this.config = config;\n\n              this.prepareConfig.call(this);\n\n              if (window.Annoto) {\n                  window.Annoto.on('ready', this.annotoReady.bind(this));\n                  if (this.params.playerType === 'videojs' && window.requirejs) {\n                      const self = this;\n                      window.require(['media_videojs/video-lazy'], function(vjs) {\n                          self.config.widgets[0].player.params = {\n                              videojs: vjs\n                          };\n                          window.Annoto.boot(self.config);\n                      });\n                  } else {\n                      window.Annoto.boot(this.config);\n                  }\n\n              } else {\n                  log.warn('AnnotoMoodle: bootstrap didn`t load');\n              }\n          },\n\n          annotoReady: function(api) {\n              // Api is the API to be used after Annoot is setup\n              // It can be used for SSO auth.\n              this.annotoAPI = api;\n              const jwt = this.params.userToken;\n              log.info('AnnotoMoodle: annoto ready');\n              if (api && jwt && jwt !== '') {\n                  api.auth(jwt).catch(function() {\n                      log.error('AnnotoMoodle: SSO auth error');\n                  });\n                  this.checkWidgetVisibility();\n              } else {\n                  log.info('AnnotoMoodle: SSO auth skipped');\n              }\n          },\n\n          authKalturaPlayer: function(api) {\n              // Api is the API to be used after Annoot is setup\n              // It can be used for SSO auth.\n              const jwt = this.params.userToken;\n              log.info('AnnotoMoodle: annoto ready');\n              if (api && jwt && jwt !== '') {\n                  api.auth(jwt).catch(function() {\n                      log.error('AnnotoMoodle: SSO auth error');\n                  });\n              } else {\n                  log.info('AnnotoMoodle: SSO auth skipped');\n              }\n          },\n\n          setupKalturaKdpMap: function(kdpMap) {\n              if (!kdpMap) {\n                  log.info('AnnotoMoodle: skip setup Kaltura players - missing map');\n                  return;\n              }\n              log.info('AnnotoMoodle: setup Kaltura players');\n              for (let kdpMapKey in kdpMap) {\n                  if (kdpMap.hasOwnProperty(kdpMapKey)) {\n                      this.setupKalturaKdp(kdpMap[kdpMapKey]);\n                  }\n              }\n          },\n          setupKalturaKdp: function(kdp) {\n              if (!kdp.config || kdp.setupDone || !kdp.doneCb) {\n                  log.info('AnnotoMoodle: skip Kaltura player: ' + kdp.id);\n                  return;\n              }\n              log.info('AnnotoMoodle: setup Kaltura player: ' + kdp.id);\n              kdp.setupDone = true;\n              kdp.player.kBind('annotoPluginReady', this.authKalturaPlayer.bind(this));\n              this.setupKalturaPlugin(kdp.config);\n              kdp.doneCb();\n          },\n          setupKalturaPlugin: function(config) {\n              /*\n               * Config will contain the annoto widget configuration.\n               * This hook provides a chance to modify the configuration if required.\n               * Below we use this chance to attach the ssoAuthRequestHandle and mediaDetails hooks.\n               * https://github.com/Annoto/widget-api/blob/master/lib/config.d.ts#L128\n               *\n               * NOTICE: config is already setup by the Kaltura Annoto plugin,\n               * so we need only to override the required configuration, such as\n               * clientId, features, etc. DO NOT CHANGE THE PLAYER TYPE OR PLAYER ELEMENT CONFIG.\n              */\n              const params = this.params;\n\n              config.clientId = params.clientId;\n              config.hooks = {\n                  getPageUrl: function() {\n                      return window.location.href;\n                  },\n                  ssoAuthRequestHandle: function() {\n                      window.location.replace(params.loginUrl);\n                  },\n                  mediaDetails: this.enrichMediaDetails.bind(this),\n              };\n              config.group = {\n                  id: params.mediaGroupId,\n                  title: params.mediaGroupTitle,\n                  description: params.mediaGroupDescription,\n              };\n              if (params.locale) {\n                  config.locale = params.locale;\n              }\n          },\n\n          enrichMediaDetails: function(mediaParams) {\n              // The details contains MediaDetails the plugin has managed to obtain\n              // This hook gives a change to enrich the details, for example\n              // providing group information for private discussions per course/playlist\n              // https://github.com/Annoto/widget-api/blob/master/lib/media-details.d.ts#L6.\n              // Annoto Kaltura plugin, already has some details about the media like title.\n              //\n              const retVal = (mediaParams && mediaParams.details) || {};\n\n              retVal.title = retVal.title || this.params.mediaTitle;\n              retVal.description = retVal.description || this.params.mediaDescription;\n\n              return retVal;\n          },\n\n          checkWidgetVisibility: function() {\n              const formatSelectors = {\n                  grid: 'body.format-grid .grid_section, body.format-grid #gridshadebox',\n                  topcoll: 'body.format-topcoll .ctopics.topics .toggledsection ',\n                  tabs: 'body.format-tabtopics .yui3-tab-panel',\n                  snap: 'body.format-topics.theme-snap .topics .section.main',\n                  modtab: '#page-mod-tab-view .TabbedPanelsContentGroup .TabbedPanelsContent'\n              };\n              let courseFormat = '',\n                  playerElement = this.params.element,\n                  self = this;\n\n              if (typeof M.tabtopics !== 'undefined') {\n                  courseFormat = 'tabs';\n              } else if (typeof M.format_grid !== 'undefined') {\n                  courseFormat = 'grid';\n              } else if (typeof M.format_topcoll !== 'undefined') {\n                      courseFormat = 'topcoll';\n              } else if (typeof M.snapTheme !== 'undefined') {\n                  courseFormat = 'snap';\n              } else if (document.body.id === 'page-mod-tab-view') {\n                  courseFormat = 'modtab';\n              }\n\n              const reloadAnnoto = function(mutationList) {\n                  let mutationTarget = null;\n\n                  if (mutationList) {\n                        switch (courseFormat) {\n                        case 'tabs':\n                          mutationTarget = mutationList.filter(function(m) {\n                            return m.target.classList.contains('yui3-tab-panel-selected');\n                          })[0].target;\n                          break;\n                        case 'grid':\n                          mutationTarget = mutationList.filter(function(m) {\n                            return !m.target.classList.contains('hide_section');\n                          })[0].target;\n                          break;\n                        case 'topcoll':\n                          mutationTarget = mutationList[0].target;\n                          break;\n                        case 'snap':\n                          mutationTarget = mutationList.filter(function(m) {\n                            return m.target.classList.contains('state-visible');\n                          })[0].target;\n                          break;\n                        case 'modtab':\n                          mutationTarget = mutationList.filter(function(m) {\n                            return m.target.classList.contains('TabbedPanelsContentVisible');\n                          })[0].target;\n                          break;\n                      }\n                  }\n\n                  playerElement = self.findPlayer(mutationTarget);\n                  if (playerElement) {\n                      self.params.element = playerElement;\n                      self.prepareConfig();\n                  }\n\n                  self.annotoAPI.destroy().then(function() {\n                      if (playerElement.offsetParent) {\n                          self.annotoAPI.load(self.config);\n                      }\n                  });\n                };\n\n              const observerNodeTargets = document.querySelectorAll(Object.values(formatSelectors).join(', '));\n\n              if (observerNodeTargets.length > 0) {\n                  const observerConfig = {attributes: true, childList: true, subtree: false},\n                      observer = new MutationObserver(reloadAnnoto);\n\n                  observerNodeTargets.forEach(function(target) {\n                      observer.observe(target, observerConfig);\n                  });\n\n                  if (playerElement.offsetParent === null) {\n                      reloadAnnoto();\n                  }\n              }\n\n          },\n\n          setupWistiaIframeEmbed: function() {\n              const wistiaplayers = document.querySelectorAll('iframe');\n              const annotoIframeClient = \"https://cdn.annoto.net/widget-iframe-api/latest/client.js\";\n              const targetHost = 'fast.wistia.net';\n              const desiredParam = {\n                  name: 'plugin[annoto][src]',\n                  value: 'cdn.annoto.net'\n              };\n\n              wistiaplayers.forEach((iframe) => {\n                  let iframeSrc;\n                  try {\n                      iframeSrc = new URL(iframe.src);\n                  } catch (err) {\n                      return;\n                  }\n                  const targetParam = iframeSrc.searchParams.get(desiredParam.name);\n                  if (iframeSrc.host !== targetHost) {\n                      return;\n                  }\n\n                  if (targetParam && targetParam.match(desiredParam.value)) {\n                      require([annotoIframeClient], this.setupWistiaIframeEmbedPlugin.bind(this, iframe));\n                      return;\n                  }\n              });\n          },\n\n          setupWistiaIframeEmbedPlugin: function(iframe, AnnotoIframeApi) {\n              const params = this.params,\n                  annoto = new AnnotoIframeApi.Client(iframe);\n\n              annoto.onSetup(function(next) {\n                  next({\n                      clientId: params.clientId,\n                      hooks: {\n                          mediaDetails: function() {\n                              return {\n                                  details: {\n                                      title: params.mediaTitle,\n                                      description: params.mediaDescription,\n                                  }\n                              };\n                          },\n                          ssoAuthRequestHandle: function() {\n                              window.location.replace(params.loginUrl);\n                          },\n                          getPageUrl: function() {\n                              return window.location.href;\n                          },\n                      },\n                      group: {\n                          id: params.mediaGroupId,\n                          title: params.mediaGroupTitle,\n                          description: params.mediaGroupDescription,\n                      },\n                      ... (params.locale) && {locale: params.locale},\n                  });\n              });\n\n              annoto.onReady(function(api) {\n                  const token = params.userToken;\n                  api.auth(token, function(err) {\n                      if (err) {\n                          log.error('AnnotoMoodle: SSO auth error', err);\n                      }\n                  });\n              });\n          },\n\n          checkVimeoTime: function() {\n              const isVimeoTime = document.getElementById('page-mod-videotime-view');\n              const self = this;\n              let setupRetry = 0;\n\n              const isReady = function() {\n                  let vimeoPlayer = document.querySelector('iframe[src*=\"vimeo.com\"]');\n                  if (!vimeoPlayer && setupRetry < 50) {\n                      setupRetry++;\n                      setTimeout(isReady, 100);\n                  } else {\n                      self.bootstrap();\n                  }\n              };\n\n              if (isVimeoTime) {\n                  isReady();\n              }\n          },\n\n          tilesInit: function() {\n              if (!document.body.classList.contains('format-tiles')) {\n                  return;\n              }\n              const self = this;\n              const formatSelectors = {\n                  tiles: 'body.format-tiles #multi_section_tiles li.section.main.moveablesection'\n              };\n\n              const reloadAnnoto = function(mutationList) {\n                  let mutationTarget = null;\n\n                  if (mutationList) {\n                      mutationTarget = mutationList.filter(function(m) {\n                          return m.attributeName === 'class' && m.target.classList.contains('state-visible');\n                      });\n                  }\n\n                  if (!mutationTarget.length) {\n                      if (self.annotoAPI && self.isloaded) {\n                          self.annotoAPI.destroy().then(self.isloaded = false);\n                      }\n                      return;\n                  }\n                  setTimeout(function() {\n                      const player = self.findPlayer(mutationTarget[0].target);\n\n                      if (player) {\n                          self.params.playerId = `#${player.id}`;\n                          if (self.bootsrapDone) {\n                              self.prepareConfig();\n                              self.annotoAPI.load(self.config).then(self.isloaded = true);\n                          } else {\n                              self.bootsrapDone = self.isloaded = true;\n                              require([self.params.bootstrapUrl], self.bootWidget.bind(self));\n                              log.info('AnnotoMoodle: detected ' + self.params.playerType + ':' + self.params.playerId);\n                          }\n                      }\n                  }, 2000);\n              };\n\n              const observerNodeTargets = document.querySelectorAll(Object.values(formatSelectors).join(', '));\n\n              if (observerNodeTargets.length > 0) {\n                  const observerConfig = {attributes: true, childList: false, subtree: false},\n                      observer = new MutationObserver(reloadAnnoto);\n\n                  observerNodeTargets.forEach(function(target) {\n                      observer.observe(target, observerConfig);\n                  });\n              }\n          },\n      };\n  });\n"],"names":["define","$","log","notification","Ajax","window","moodleAnnoto","sessionStorage","getItem","console","err","init","courseid","modid","info","call","methodname","args","done","response","result","params","JSON","parse","this","hasAnnotoTag","tilesInit","setupKaltura","setupWistiaIframeEmbed","checkVimeoTime","moodleversion","document","ready","bootstrap","bind","warn","fail","exception","maKApp","kApp","setupKalturaKdpMap","kdpMap","length","findPlayer","container","parent","body","h5p","find","first","get","youtube","vimeo","videojs","jwplayer","wistia","html5","playerElement","playerType","youtubeSrc","src","search","id","Math","random","toString","substr","playerId","element","innerPage","querySelector","newDiv","createElement","appendChild","bootsrapDone","require","bootstrapUrl","bootWidget","prepareConfig","config","widgets","player","type","timeline","overlay","indexOf","backend","domain","deploymentDomain","clientId","hooks","mediaDetails","details","title","mediaTitle","description","mediaDescription","ssoAuthRequestHandle","location","replace","loginUrl","group","mediaGroupId","mediaGroupTitle","mediaGroupDescription","locale","Annoto","on","annotoReady","requirejs","self","vjs","boot","api","annotoAPI","jwt","userToken","auth","catch","error","checkWidgetVisibility","authKalturaPlayer","kdpMapKey","hasOwnProperty","setupKalturaKdp","kdp","setupDone","doneCb","kBind","setupKalturaPlugin","getPageUrl","href","enrichMediaDetails","mediaParams","retVal","courseFormat","M","tabtopics","format_grid","format_topcoll","snapTheme","reloadAnnoto","mutationList","mutationTarget","filter","m","target","classList","contains","destroy","then","offsetParent","load","observerNodeTargets","querySelectorAll","Object","values","grid","topcoll","tabs","snap","modtab","join","observerConfig","attributes","childList","subtree","observer","MutationObserver","forEach","observe","wistiaplayers","desiredParam","iframe","iframeSrc","URL","targetParam","searchParams","host","match","setupWistiaIframeEmbedPlugin","AnnotoIframeApi","annoto","Client","onSetup","next","onReady","token","isVimeoTime","getElementById","setupRetry","isReady","setTimeout","attributeName","isloaded","tiles"],"mappings":"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"}